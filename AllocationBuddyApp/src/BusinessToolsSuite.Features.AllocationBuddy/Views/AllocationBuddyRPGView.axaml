<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BusinessToolsSuite.Features.AllocationBuddy.ViewModels"
             x:Class="BusinessToolsSuite.Features.AllocationBuddy.Views.AllocationBuddyRPGView"
             x:DataType="vm:AllocationBuddyRPGViewModel">

  <Grid RowDefinitions="Auto,Auto,*,Auto">
    <!-- Toolbar / Header -->
    <Border Grid.Row="0" Background="{DynamicResource PrimaryBrush}" Padding="10">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
          <TextBlock Text="Business Tools Suite" Foreground="White" FontWeight="Bold" FontSize="14"/>
          <TextBlock Text=" - Allocation Buddy" Foreground="White" FontSize="14" Margin="6,0,0,0"/>
        </StackPanel>

        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
          <Button Command="{Binding ImportCommand}" Content="ðŸ“¥ Import" MinWidth="110"/>
          <Button Command="{Binding RefreshCommand}" Content="ðŸ” Refresh" MinWidth="90"/>
          <Button Content="ðŸ“¤ Export" MinWidth="90"/>
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="12">
          <TextBlock Text="Entries:" Foreground="White" VerticalAlignment="Center"/>
          <TextBlock Text="{Binding TotalEntries}" Foreground="White" FontWeight="Bold" VerticalAlignment="Center"/>
        </StackPanel>
      </Grid>
    </Border>

    <!-- Filters -->
    <Border Grid.Row="1" Padding="12" Background="{DynamicResource SurfaceBrush}">
      <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
        <TextBox Width="460" Watermark="Search by item number, description, or location..." Text="{Binding SearchText}"/>
        <ComboBox Width="140" SelectedIndex="0">
          <ComboBoxItem>All Stores</ComboBoxItem>
        </ComboBox>
          <Button Content="Clear" Command="{Binding ClearCommand}" MinWidth="80"/>
        <TextBlock Text="Locations:" VerticalAlignment="Center"/>
        <TextBlock Text="{Binding LocationsCount}" FontWeight="Bold" VerticalAlignment="Center"/>
      </StackPanel>
    </Border>

    <!-- RPG Stat Screen: left = locations (wrap), right = item pool -->
    <ScrollViewer Grid.Row="2">
      <Grid Margin="12">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="340" />
        </Grid.ColumnDefinitions>

        <!-- Locations rendered as cards in a WrapPanel inside the ItemsControl -->
        <ItemsControl Grid.Column="0" ItemsSource="{Binding LocationAllocations}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <WrapPanel Orientation="Horizontal" />
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>

          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border Background="#FFF" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Padding="12" Width="320" Margin="6">
                          <StackPanel>
                            <Grid Opacity="{Binding IsActive, Converter={StaticResource BoolToOpacityConverter}}">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal" Grid.Column="0">
                          <TextBlock Text="{Binding Location}" FontWeight="Bold" FontSize="16"/>
                          <TextBlock Text=" (" Foreground="#666" Margin="6,0,0,0"/>
                          <TextBlock Text="{Binding Items.Count}" Foreground="#666"/>
                          <TextBlock Text=" items)" Foreground="#666"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                          <Button Command="{Binding DataContext.DeactivateStoreCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Content="Deactivate" Margin="6,0,0,0"/>
                        </StackPanel>
                      </Grid>
                  <StackPanel Margin="0,8,0,0">
                    <ItemsControl ItemsSource="{Binding Items}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Background="{Binding IsUpdated, Converter={StaticResource BoolToHighlightBrushConverter}}" CornerRadius="4" Padding="4">
                            <Grid VerticalAlignment="Center" Margin="0,0,0,6">
                              <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="80" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="40" /> <!-- left button -->
                                <ColumnDefinition Width="60" /> <!-- quantity -->
                                <ColumnDefinition Width="40" /> <!-- right button -->
                              </Grid.ColumnDefinitions>

                              <TextBlock Grid.Column="0" Text="{Binding Description}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                              <TextBlock Grid.Column="1" Text="{Binding ItemNumber}" VerticalAlignment="Center" Margin="8,0,0,0"/>

                              <Button Grid.Column="3" Content="â†" Command="{Binding DataContext.RemoveOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Width="32" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="6,0,0,0"/>

                              <TextBlock Grid.Column="4" Text="{Binding Quantity}" VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="SemiBold"/>

                              <Button Grid.Column="5" Content="â†’" Command="{Binding DataContext.AddOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Width="32" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="6,0,0,0"/>
                            </Grid>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </StackPanel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Item Pool column -->
        <Border Grid.Column="1" Background="#F9F9F9" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Padding="12" Margin="6">
            <StackPanel>
            <!-- Drag & drop area header -->
            <Border x:Name="DropArea" Background="#FFF5" Padding="8" CornerRadius="6" Margin="0,0,0,8">
              <StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
                  <TextBlock Text="Drop .xlsx or .csv files here" VerticalAlignment="Center" Foreground="#333"/>
                  <Button Command="{Binding ImportCommand}" Content="Or click to choose" MinWidth="140"/>
                </StackPanel>

                <ItemsControl ItemsSource="{Binding FileImportResults}" Margin="0,8,0,0">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Padding="4" Margin="0,4,0,0" Background="#FFF" CornerRadius="4" BorderBrush="#EEE" BorderThickness="1">
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding FileName}" FontWeight="Bold" Width="180"/>
                        <TextBlock Text="{Binding Count, StringFormat='Entries: {0}'}" Width="100"/>
                        <TextBlock Text="{Binding Message}" Foreground="#666"/>
                        <TextBlock Text="{Binding Success}" HorizontalAlignment="Right"/>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
                </ItemsControl>
              </StackPanel>
            </Border>

            <TextBlock Text="Item Pool" FontWeight="Bold" FontSize="16"/>
            <TextBlock Text="{Binding ItemPool.Count, StringFormat='Pool: {0} items'}" FontSize="12" Foreground="#666"/>
            <ItemsControl ItemsSource="{Binding ItemPool}" Margin="0,8,0,0">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Padding="2">
                    <Grid VerticalAlignment="Center" Margin="0,0,0,6">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="90" />
                        <ColumnDefinition Width="70" />
                        <ColumnDefinition Width="40" />
                      </Grid.ColumnDefinitions>

                      <TextBlock Grid.Column="0" Text="{Binding Description}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                      <TextBlock Grid.Column="1" Text="{Binding ItemNumber}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                      <TextBlock Grid.Column="2" Text="{Binding Quantity, StringFormat='Qty: {0}'}" VerticalAlignment="Center" Margin="8,0,0,0"/>

                      <!-- Removed direct-move arrow from pool; only allow explicit selection -->
                      <Button Grid.Column="3" Content="â‹¯" Command="{Binding DataContext.SelectAndMoveFromPoolCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}" Width="32" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="6,0,0,0" ToolTip.Tip="Choose target location..."/>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

      </Grid>
    </ScrollViewer>

    <!-- Status Bar -->
    <Border Grid.Row="3" Padding="8">
      <TextBlock Text="{Binding FooterMessage}"/>
    </Border>
  </Grid>
</UserControl>