<Window x:Class="MechaRogue.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:MechaRogue.Converters"
        xmlns:ctrl="clr-namespace:MechaRogue.Controls"
        xmlns:models="clr-namespace:MechaRogue.Models"
        Title="MechaRogue â€“ Medabots Roguelike"
        Width="1100" Height="750" MinWidth="900" MinHeight="600"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BgBrush}">

    <Window.Resources>
        <conv:StringMatchToVisibilityConverter x:Key="ScreenVis" />
        <conv:BoolToVisibilityConverter x:Key="BoolVis" />
        <conv:ArmorPercentToBrushConverter x:Key="ArmorColor" />
        <conv:NodeTypeToIconConverter x:Key="NodeIcon" />
        <conv:NodeTypeToBrushConverter x:Key="NodeColor" />
        <conv:PartCostConverter x:Key="PartCost" />
        <conv:BattlePhaseToVisibilityConverter x:Key="PhaseVis" />

        <!-- Small accent button used often -->
        <Style x:Key="SmallBtn" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Padding" Value="10,5" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!-- Part selector button in battle -->
        <Style x:Key="PartBtn" TargetType="Button" BasedOn="{StaticResource ActionButton}">
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="Margin" Value="3" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>
    </Window.Resources>

    <Grid>
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  TITLE SCREEN                                   -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Title}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="âš™ MECHAROGUE âš™"
                           FontSize="42" FontWeight="Bold"
                           Foreground="{StaticResource AccentBrush}"
                           HorizontalAlignment="Center" />
                <TextBlock Text="A Medabots Roguelike"
                           Style="{StaticResource SubtitleText}"
                           FontSize="16" HorizontalAlignment="Center" Margin="0,4,0,30" />

                <TextBlock Text="Choose your starter Medabot:"
                           HorizontalAlignment="Center" Margin="0,0,0,12"
                           Foreground="{StaticResource TextDimBrush}" />

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Style="{StaticResource ActionButton}"
                            Command="{Binding StartNewRunCommand}"
                            Margin="8" Padding="24,14" FontSize="15">
                        <StackPanel>
                            <TextBlock Text="ðŸª² Metabee" FontWeight="Bold" FontSize="16" Foreground="{StaticResource WarningBrush}" />
                            <TextBlock Text="KBT-1 Â· Balanced Shooter" Foreground="{StaticResource TextDimBrush}" FontSize="11" />
                            <TextBlock Text="Kabuto Medal Â· Shooting affinity" Foreground="{StaticResource TextDimBrush}" FontSize="10" />
                        </StackPanel>
                    </Button>

                    <Button Style="{StaticResource ActionButton}"
                            Command="{Binding StartWithRokushoCommand}"
                            Margin="8" Padding="24,14" FontSize="15">
                        <StackPanel>
                            <TextBlock Text="âš” Rokusho" FontWeight="Bold" FontSize="16" Foreground="{StaticResource AccentBrush}" />
                            <TextBlock Text="KWG-1 Â· Fast Melee" Foreground="{StaticResource TextDimBrush}" FontSize="11" />
                            <TextBlock Text="Kuwagata Medal Â· Speed + Melee" Foreground="{StaticResource TextDimBrush}" FontSize="10" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <TextBlock Text="Destroy the enemy's Head to win! Parts take targeted damage."
                           Foreground="{StaticResource TextDimBrush}" FontSize="11"
                           HorizontalAlignment="Center" Margin="0,24,0,0" />
                <TextBlock Text="Win parts from defeated foes. Survive 15 floors to victory."
                           Foreground="{StaticResource TextDimBrush}" FontSize="11"
                           HorizontalAlignment="Center" Margin="0,2,0,0" />
            </StackPanel>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  MAP SCREEN                                     -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Map}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Header bar -->
            <Border Grid.Row="0" Style="{StaticResource Card}" Margin="12,12,12,0" Padding="16,10">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Left" FontSize="16" FontWeight="Bold">
                        <Run Text="Floor " /><Run Text="{Binding Run.Floor, Mode=OneWay, FallbackValue=1}" Foreground="{StaticResource AccentBrush}" />
                        <Run Text="/" /><Run Text="{Binding Run.MaxFloors, Mode=OneWay, FallbackValue=15}" />
                    </TextBlock>
                    <TextBlock DockPanel.Dock="Right" HorizontalAlignment="Right" FontSize="14">
                        <Run Text="ðŸ’° " /><Run Text="{Binding Run.Credits, Mode=OneWay, FallbackValue=0}" Foreground="{StaticResource WarningBrush}" />
                        <Run Text="  |  Squad: " /><Run Text="{Binding Run.Squad.Count, Mode=OneWay, FallbackValue=0}" />
                        <Run Text="  |  Parts: " /><Run Text="{Binding Run.SpareParts.Count, Mode=OneWay, FallbackValue=0}" />
                    </TextBlock>
                </DockPanel>
            </Border>

            <!-- Node selection -->
            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Choose your path:" FontSize="16"
                           HorizontalAlignment="Center" Margin="0,0,0,16"
                           Foreground="{StaticResource TextDimBrush}" />

                <ItemsControl ItemsSource="{Binding AvailableNodes}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Style="{StaticResource ActionButton}"
                                    Command="{Binding DataContext.SelectNodeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}"
                                    Margin="8" Padding="20,16" MinWidth="140">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding Type, Converter={StaticResource NodeIcon}}"
                                               FontSize="28" HorizontalAlignment="Center" />
                                    <TextBlock Text="{Binding Label}" FontSize="13"
                                               HorizontalAlignment="Center" Margin="0,4,0,0"
                                               Foreground="{Binding Type, Converter={StaticResource NodeColor}}" />
                                    <TextBlock FontSize="10" HorizontalAlignment="Center"
                                               Foreground="{StaticResource TextDimBrush}">
                                        <Run Text="Depth " /><Run Text="{Binding Depth, Mode=OneWay}" />
                                    </TextBlock>
                                </StackPanel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>

            <!-- Squad + Inventory at bottom -->
            <Grid Grid.Row="2" Margin="12,0,12,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="320" />
                </Grid.ColumnDefinitions>

                <!-- Squad overview -->
                <Border Grid.Column="0" Style="{StaticResource Card}" Margin="0,0,6,0" Padding="10,6">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="SQUAD" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource TextDimBrush}" Margin="0,0,0,4" />
                        <ItemsControl ItemsSource="{Binding Run.Squad}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource Card}" Margin="4,0" Padding="8,5" MinWidth="150">
                                        <StackPanel>
                                            <DockPanel>
                                                <ctrl:MedabotSprite Bot="{Binding}" SpriteScale="2"
                                                                    DockPanel.Dock="Left" Margin="0,0,6,0" />
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="12" />
                                                    <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}">
                                                        <Run Text="{Binding ModelId, Mode=OneWay}" />
                                                        <Run Text=" Lv." /><Run Text="{Binding Medal.Level, Mode=OneWay}" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </DockPanel>
                                            <ProgressBar Style="{StaticResource ArmorBar}"
                                                         Minimum="0" Maximum="{Binding TotalMaxArmor}"
                                                         Value="{Binding TotalArmor, Mode=OneWay}"
                                                         Foreground="{Binding HealthPercent, Converter={StaticResource ArmorColor}}"
                                                         Margin="0,4,0,0" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </DockPanel>
                </Border>

                <!-- Spare parts inventory -->
                <Border Grid.Column="1" Style="{StaticResource Card}" Padding="10,6">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="SPARE PARTS" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource TextDimBrush}" Margin="0,0,0,4" />
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120">
                            <ItemsControl ItemsSource="{Binding Run.SpareParts}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <DockPanel Margin="0,1">
                                            <Button DockPanel.Dock="Right" Style="{StaticResource SmallBtn}"
                                                    Content="Equip"
                                                    Command="{Binding DataContext.EquipPartCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    Padding="6,2" FontSize="10" />
                                            <TextBlock FontSize="11" VerticalAlignment="Center">
                                                <Run Text="{Binding Name, Mode=OneWay}" />
                                                <Run Text=" [" Foreground="{StaticResource TextDimBrush}" /><Run Text="{Binding Slot, Mode=OneWay}" Foreground="{StaticResource TextDimBrush}" /><Run Text="]" Foreground="{StaticResource TextDimBrush}" />
                                            </TextBlock>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </DockPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  BATTLE SCREEN                                  -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Battle}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Turn + status header -->
            <Border Grid.Row="0" Style="{StaticResource Card}" Margin="12,12,12,0" Padding="12,8">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Left" FontSize="14" FontWeight="Bold">
                        <Run Text="Turn " /><Run Text="{Binding TurnNumber, FallbackValue=0}" Foreground="{StaticResource AccentBrush}" />
                    </TextBlock>
                    <TextBlock DockPanel.Dock="Right" HorizontalAlignment="Right" FontSize="12"
                               Foreground="{StaticResource TextDimBrush}">
                        <Run Text="Floor " /><Run Text="{Binding Run.Floor, Mode=OneWay, FallbackValue=1}" />
                    </TextBlock>
                </DockPanel>
            </Border>

            <!-- Main battle area -->
            <Grid Grid.Row="1" Margin="12,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="170" />   <!-- Player stats -->
                    <ColumnDefinition Width="*" />     <!-- Center: arena + log -->
                    <ColumnDefinition Width="170" />   <!-- Enemy stats -->
                </Grid.ColumnDefinitions>

                <!-- === PLAYER MEDABOT (stats only â€” sprite in arena) === -->
                <Border Grid.Column="0" Style="{StaticResource Card}" Margin="0,0,4,0" Padding="8,6">
                    <StackPanel>
                        <TextBlock Text="YOUR MEDABOT" FontSize="9" FontWeight="Bold"
                                   Foreground="{StaticResource AccentBrush}" Margin="0,0,0,4" />

                        <TextBlock Text="{Binding PlayerActiveMech.Name, FallbackValue=???}"
                                   FontSize="14" FontWeight="Bold" />
                        <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}">
                            <Run Text="{Binding PlayerActiveMech.ModelId, Mode=OneWay, FallbackValue=---}" />
                            <Run Text=" Â· Lv." />
                            <Run Text="{Binding PlayerActiveMech.Medal.Level, Mode=OneWay, FallbackValue=1}" />
                        </TextBlock>
                        <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}" Margin="0,2,0,6">
                            <Run Text="SPD:" /><Run Text="{Binding PlayerActiveMech.EffectiveSpeed, Mode=OneWay, FallbackValue=0}" />
                            <Run Text=" EVA:" /><Run Text="{Binding PlayerActiveMech.EffectiveEvasion, Mode=OneWay, FallbackValue=0}" />
                        </TextBlock>

                        <!-- Part armor bars -->
                        <TextBlock Text="PARTS" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource TextDimBrush}" Margin="0,0,0,4" />
                        <ItemsControl ItemsSource="{Binding PlayerActiveMech.AllParts}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="70" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="60" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Slot}" FontSize="10"
                                                   Foreground="{StaticResource TextDimBrush}" VerticalAlignment="Center" />
                                        <ProgressBar Grid.Column="1" Style="{StaticResource ArmorBar}"
                                                     Minimum="0" Maximum="{Binding MaxArmor}"
                                                     Value="{Binding Armor, Mode=OneWay}"
                                                     Foreground="{Binding ArmorPercent, Converter={StaticResource ArmorColor}}" />
                                        <TextBlock Grid.Column="2" FontSize="10" Margin="6,0,0,0"
                                                   VerticalAlignment="Center" HorizontalAlignment="Right">
                                            <Run Text="{Binding Armor, Mode=OneWay}" />/<Run Text="{Binding MaxArmor, Mode=OneWay}" />
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Medaforce bar -->
                        <TextBlock Text="MEDAFORCE" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource MedaforceBrush}" Margin="0,8,0,2" />
                        <ProgressBar Style="{StaticResource ArmorBar}" Height="6"
                                     Minimum="0"
                                     Maximum="{Binding PlayerActiveMech.Medal.MaxMedaforce, FallbackValue=100}"
                                     Value="{Binding PlayerActiveMech.Medal.MedaforceCharge, Mode=OneWay, FallbackValue=0}"
                                     Foreground="{StaticResource MedaforceBrush}" />

                        <!-- Charge gauge -->
                        <TextBlock Text="CHARGE" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource AccentBrush}" Margin="0,6,0,2" />
                        <ProgressBar Style="{StaticResource ArmorBar}" Height="8"
                                     Minimum="0" Maximum="100"
                                     Value="{Binding PlayerCharge, Mode=OneWay}"
                                     Foreground="{StaticResource AccentBrush}" />
                    </StackPanel>
                </Border>

                <!-- === CENTER: ANIMATED ARENA + BATTLE LOG === -->
                <Border Grid.Column="1" Style="{StaticResource Card}" Margin="4,0" Padding="0"
                        ClipToBounds="True">
                    <DockPanel>
                        <!-- Animated battlefield on top -->
                        <ctrl:BattlefieldCanvas x:Name="BattleArena" DockPanel.Dock="Top"
                                                PlayerBot="{Binding PlayerActiveMech}"
                                                EnemyBot="{Binding EnemyActiveMech}"
                                                PlayerChargeValue="{Binding PlayerCharge}"
                                                EnemyChargeValue="{Binding EnemyCharge}"
                                                HorizontalAlignment="Stretch" />

                        <!-- Separator -->
                        <Border DockPanel.Dock="Top" Height="1" Margin="6,0"
                                Background="{StaticResource BorderBrush}" />

                        <!-- Battle log below -->
                        <DockPanel Margin="8,4,8,6">
                            <TextBlock DockPanel.Dock="Top" Text="BATTLE LOG" FontSize="10" FontWeight="Bold"
                                       Foreground="{StaticResource TextDimBrush}" Margin="0,0,0,6" />
                            <ListBox x:Name="BattleLogBox"
                                     ItemsSource="{Binding BattleLog}"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                     IsHitTestVisible="False">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" TextWrapping="Wrap"
                                                   FontSize="11" Margin="0,1"
                                                   Foreground="{StaticResource TextBrush}" />
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </DockPanel>
                    </DockPanel>
                </Border>

                <!-- === ENEMY MEDABOT (stats only â€” sprite in arena) === -->
                <Border Grid.Column="2" Style="{StaticResource Card}" Margin="4,0,0,0" Padding="8,6">
                    <StackPanel>
                        <TextBlock Text="ENEMY" FontSize="9" FontWeight="Bold"
                                   Foreground="{StaticResource DangerBrush}" Margin="0,0,0,4" />

                        <TextBlock Text="{Binding EnemyActiveMech.Name, FallbackValue=???}"
                                   FontSize="14" FontWeight="Bold" HorizontalAlignment="Right" />
                        <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}"
                                   HorizontalAlignment="Right">
                            <Run Text="{Binding EnemyActiveMech.ModelId, Mode=OneWay, FallbackValue=---}" />
                        </TextBlock>
                        <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}"
                                   HorizontalAlignment="Right" Margin="0,2,0,6">
                            <Run Text="SPD:" /><Run Text="{Binding EnemyActiveMech.EffectiveSpeed, Mode=OneWay, FallbackValue=0}" />
                            <Run Text=" EVA:" /><Run Text="{Binding EnemyActiveMech.EffectiveEvasion, Mode=OneWay, FallbackValue=0}" />
                        </TextBlock>

                        <!-- Enemy part armor bars -->
                        <TextBlock Text="PARTS" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource TextDimBrush}" Margin="0,0,0,4" />
                        <ItemsControl ItemsSource="{Binding EnemyActiveMech.AllParts}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="70" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="60" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Slot}" FontSize="10"
                                                   Foreground="{StaticResource TextDimBrush}" VerticalAlignment="Center" />
                                        <ProgressBar Grid.Column="1" Style="{StaticResource ArmorBar}"
                                                     Minimum="0" Maximum="{Binding MaxArmor}"
                                                     Value="{Binding Armor, Mode=OneWay}"
                                                     Foreground="{Binding ArmorPercent, Converter={StaticResource ArmorColor}}" />
                                        <TextBlock Grid.Column="2" FontSize="10" Margin="6,0,0,0"
                                                   VerticalAlignment="Center" HorizontalAlignment="Right">
                                            <Run Text="{Binding Armor, Mode=OneWay}" />/<Run Text="{Binding MaxArmor, Mode=OneWay}" />
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Enemy Medaforce bar -->
                        <ProgressBar Style="{StaticResource ArmorBar}" Height="6" Margin="0,8,0,0"
                                     Minimum="0"
                                     Maximum="{Binding EnemyActiveMech.Medal.MaxMedaforce, FallbackValue=100}"
                                     Value="{Binding EnemyActiveMech.Medal.MedaforceCharge, Mode=OneWay, FallbackValue=0}"
                                     Foreground="{StaticResource MedaforceBrush}" />

                        <!-- Enemy Charge gauge -->
                        <TextBlock Text="CHARGE" FontSize="10" FontWeight="Bold"
                                   Foreground="{StaticResource DangerBrush}" Margin="0,6,0,2" />
                        <ProgressBar Style="{StaticResource ArmorBar}" Height="8"
                                     Minimum="0" Maximum="100"
                                     Value="{Binding EnemyCharge, Mode=OneWay}"
                                     Foreground="{StaticResource DangerBrush}" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- â”€â”€ Action panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <Border Grid.Row="2" Style="{StaticResource Card}" Margin="12,0,12,12" Padding="12,8">
                <Grid>                    <!-- Charging status (visible when gauges filling) -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding BattlePhase, Converter={StaticResource PhaseVis}, ConverterParameter=Charging}">
                        <TextBlock Text="âš¡ Charge gauges filling..." FontSize="14"
                                   Foreground="{StaticResource AccentBrush}" FontWeight="SemiBold" />
                        <TextBlock FontSize="12" Foreground="{StaticResource TextDimBrush}" Margin="16,0,0,0"
                                   VerticalAlignment="Center">
                            <Run Text="You: " /><Run Text="{Binding PlayerCharge, StringFormat='{}{0:F0}%', Mode=OneWay}" Foreground="{StaticResource AccentBrush}" />
                            <Run Text="  Enemy: " /><Run Text="{Binding EnemyCharge, StringFormat='{}{0:F0}%', Mode=OneWay}" Foreground="{StaticResource DangerBrush}" />
                        </TextBlock>
                    </StackPanel>

                    <!-- Executing status (visible during animation) -->
                    <TextBlock Text="âš” Executing action..." FontSize="14" FontWeight="SemiBold"
                               Foreground="{StaticResource WarningBrush}"
                               HorizontalAlignment="Center" VerticalAlignment="Center"
                               Visibility="{Binding BattlePhase, Converter={StaticResource PhaseVis}, ConverterParameter=Executing}" />
                    <!-- Active combat controls (only during ActionSelect & player turn) -->
                    <StackPanel>
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsPlayerTurn}" Value="True" />
                                            <Condition Binding="{Binding BattlePhase}" Value="ActionSelect" />
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible" />
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <DockPanel>
                            <TextBlock DockPanel.Dock="Left" Text="SELECT ACTION" FontSize="10"
                                       FontWeight="Bold" Foreground="{StaticResource TextDimBrush}"
                                       VerticalAlignment="Center" Margin="0,0,12,0" />

                            <!-- Target slot picker -->
                            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" HorizontalAlignment="Right">
                                <TextBlock Text="Target:" FontSize="11" VerticalAlignment="Center"
                                           Foreground="{StaticResource TextDimBrush}" Margin="0,0,6,0" />
                                <Button Style="{StaticResource SmallBtn}" Content="Head"
                                        Command="{Binding SelectTargetCommand}" CommandParameter="Head" />
                                <Button Style="{StaticResource SmallBtn}" Content="R.Arm"
                                        Command="{Binding SelectTargetCommand}" CommandParameter="RightArm" />
                                <Button Style="{StaticResource SmallBtn}" Content="L.Arm"
                                        Command="{Binding SelectTargetCommand}" CommandParameter="LeftArm" />
                                <Button Style="{StaticResource SmallBtn}" Content="Legs"
                                        Command="{Binding SelectTargetCommand}" CommandParameter="Legs" />
                                <TextBlock FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"
                                           Foreground="{StaticResource AccentBrush}">
                                    <Run Text="â†’ " /><Run Text="{Binding SelectedTargetSlot, Mode=OneWay}" />
                                </TextBlock>
                            </StackPanel>
                        </DockPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <!-- Usable parts as attack buttons -->
                            <ItemsControl ItemsSource="{Binding PlayerActiveMech.UsableParts}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource PartBtn}"
                                                Command="{Binding DataContext.SelectAttackPartCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}">
                                            <StackPanel>
                                                <TextBlock FontSize="12" FontWeight="SemiBold">
                                                    <Run Text="{Binding Slot, Mode=OneWay}" />
                                                    <Run Text=": " />
                                                    <Run Text="{Binding Name, Mode=OneWay}" />
                                                </TextBlock>
                                                <TextBlock FontSize="10" Foreground="{StaticResource TextDimBrush}">
                                                    <Run Text="PWR:" /><Run Text="{Binding Power, Mode=OneWay}" />
                                                    <Run Text=" ACC:" /><Run Text="{Binding Accuracy, Mode=OneWay}" />
                                                    <Run Text=" " /><Run Text="{Binding Skill, Mode=OneWay}" />
                                                </TextBlock>
                                            </StackPanel>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Attack + Medaforce buttons -->
                            <Button Style="{StaticResource ActionButton}" Margin="12,0,4,0"
                                    Command="{Binding ExecuteAttackCommand}"
                                    Padding="20,8" FontSize="14" FontWeight="Bold">
                                <TextBlock>
                                    <Run Text="âš” ATTACK" />
                                </TextBlock>
                            </Button>

                            <Button Style="{StaticResource DangerButton}" Margin="4,0"
                                    Command="{Binding UseMedaforceCommand}"
                                    IsEnabled="{Binding PlayerActiveMech.Medal.CanUseMedaforce, FallbackValue=False}"
                                    Padding="16,8" FontSize="13">
                                <TextBlock Foreground="{StaticResource MedaforceBrush}">
                                    <Run Text="âœ¦ MEDAFORCE" />
                                </TextBlock>
                            </Button>
                        </StackPanel>

                        <!-- Selected part info -->
                        <TextBlock FontSize="11" Margin="0,4,0,0" Foreground="{StaticResource TextDimBrush}">
                            <Run Text="Selected: " />
                            <Run Text="{Binding SelectedPart.Name, Mode=OneWay, FallbackValue=None}" Foreground="{StaticResource AccentBrush}" />
                            <Run Text=" â†’ " />
                            <Run Text="{Binding SelectedTargetSlot, Mode=OneWay}" Foreground="{StaticResource WarningBrush}" />
                        </TextBlock>
                    </StackPanel>

                    <!-- Battle-over continue button -->
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding BattlePhase, Converter={StaticResource PhaseVis}, ConverterParameter=BattleOver}">
                        <Button Style="{StaticResource ActionButton}"
                                Command="{Binding ContinueAfterBattleCommand}"
                                Padding="24,10" FontSize="14" Content="Continue â†’" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  SHOP SCREEN                                    -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Shop}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" MaxWidth="700">
                <TextBlock Text="ðŸ›’ PARTS SHOP" Style="{StaticResource TitleText}"
                           HorizontalAlignment="Center" Margin="0,0,0,4" />
                <TextBlock HorizontalAlignment="Center" FontSize="14" Margin="0,0,0,20"
                           Foreground="{StaticResource WarningBrush}">
                    <Run Text="Credits: " /><Run Text="{Binding Run.Credits, Mode=OneWay, FallbackValue=0}" />
                </TextBlock>

                <ItemsControl ItemsSource="{Binding ShopParts}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Style="{StaticResource Card}" Margin="0,4" Padding="12,8">
                                <DockPanel>
                                    <Button DockPanel.Dock="Right" Style="{StaticResource ActionButton}"
                                            Command="{Binding DataContext.BuyPartCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Padding="14,6" VerticalAlignment="Center">
                                        <TextBlock>
                                            <Run Text="Buy " />
                                            <Run Text="{Binding Converter={StaticResource PartCost}, Mode=OneWay}" />
                                        </TextBlock>
                                    </Button>
                                    <StackPanel>
                                        <TextBlock FontSize="14" FontWeight="SemiBold">
                                            <Run Text="{Binding Name, Mode=OneWay}" />
                                            <Run Text=" [" /><Run Text="{Binding Slot, Mode=OneWay}" /><Run Text="]" />
                                        </TextBlock>
                                        <TextBlock FontSize="11" Foreground="{StaticResource TextDimBrush}">
                                            <Run Text="PWR:" /><Run Text="{Binding Power, Mode=OneWay}" />
                                            <Run Text="  ACC:" /><Run Text="{Binding Accuracy, Mode=OneWay}" />
                                            <Run Text="  ARM:" /><Run Text="{Binding MaxArmor, Mode=OneWay}" />
                                            <Run Text="  Tier:" /><Run Text="{Binding Tier, Mode=OneWay}" />
                                            <Run Text="  " /><Run Text="{Binding Skill, Mode=OneWay}" />
                                        </TextBlock>
                                    </StackPanel>
                                </DockPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <Button Style="{StaticResource ActionButton}" Content="Leave Shop â†’"
                        Command="{Binding LeaveShopCommand}"
                        HorizontalAlignment="Center" Margin="0,20,0,0" Padding="24,10" />
            </StackPanel>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  REST SCREEN                                    -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Rest}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="ðŸ”§ REST STOP" Style="{StaticResource TitleText}"
                           HorizontalAlignment="Center" Margin="0,0,0,8" />
                <TextBlock Text="Your Medabots receive maintenance and repairs."
                           Foreground="{StaticResource TextDimBrush}" FontSize="14"
                           HorizontalAlignment="Center" Margin="0,0,0,24" />
                <TextBlock Text="All parts healed by 50%."
                           Foreground="{StaticResource SuccessBrush}" FontSize="16"
                           HorizontalAlignment="Center" Margin="0,0,0,24" />
                <Button Style="{StaticResource ActionButton}" Content="Rest and Continue â†’"
                        Command="{Binding RestAndRepairCommand}"
                        HorizontalAlignment="Center" Padding="24,10" FontSize="14" />
            </StackPanel>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  EVENT SCREEN                                   -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Event}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" MaxWidth="500">
                <TextBlock Text="â“ RANDOM EVENT" Style="{StaticResource TitleText}"
                           HorizontalAlignment="Center" Margin="0,0,0,16" />
                <Border Style="{StaticResource Card}" Padding="20,16" Margin="0,0,0,20">
                    <TextBlock Text="{Binding EventText}" FontSize="15" TextWrapping="Wrap"
                               Foreground="{StaticResource TextBrush}" />
                </Border>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Style="{StaticResource ActionButton}" Margin="6"
                            Command="{Binding EventOption1Command}"
                            Padding="18,10" Content="{Binding EventChoice1}" />
                    <Button Style="{StaticResource ActionButton}" Margin="6"
                            Command="{Binding EventOption2Command}"
                            Padding="18,10" Content="{Binding EventChoice2}" />
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GAME OVER SCREEN                               -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=GameOver}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="GAME OVER" FontSize="40" FontWeight="Bold"
                           Foreground="{StaticResource DangerBrush}" HorizontalAlignment="Center" />
                <TextBlock FontSize="16" HorizontalAlignment="Center" Margin="0,8,0,24"
                           Foreground="{StaticResource TextDimBrush}">
                    <Run Text="Reached Floor " /><Run Text="{Binding Run.Floor, Mode=OneWay, FallbackValue=?}" />
                    <Run Text=" Â· Wins: " /><Run Text="{Binding Run.Wins, Mode=OneWay, FallbackValue=0}" />
                </TextBlock>
                <Button Style="{StaticResource DangerButton}" Content="Return to Title"
                        Command="{Binding ReturnToTitleCommand}"
                        Padding="24,10" FontSize="14" />
            </StackPanel>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  VICTORY SCREEN                                 -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid Visibility="{Binding ScreenState, Converter={StaticResource ScreenVis}, ConverterParameter=Victory}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="ðŸ† VICTORY!" FontSize="42" FontWeight="Bold"
                           Foreground="{StaticResource WarningBrush}" HorizontalAlignment="Center" />
                <TextBlock Text="You've conquered all 15 floors!"
                           FontSize="16" HorizontalAlignment="Center" Margin="0,8,0,4"
                           Foreground="{StaticResource TextBrush}" />
                <TextBlock FontSize="14" HorizontalAlignment="Center" Margin="0,0,0,24"
                           Foreground="{StaticResource TextDimBrush}">
                    <Run Text="Wins: " /><Run Text="{Binding Run.Wins, Mode=OneWay, FallbackValue=0}" />
                    <Run Text=" Â· Squad: " /><Run Text="{Binding Run.Squad.Count, Mode=OneWay, FallbackValue=0}" />
                    <Run Text=" Â· Parts: " /><Run Text="{Binding Run.SpareParts.Count, Mode=OneWay, FallbackValue=0}" />
                </TextBlock>
                <Button Style="{StaticResource ActionButton}" Content="Play Again"
                        Command="{Binding ReturnToTitleCommand}"
                        Padding="24,10" FontSize="14" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
