<UserControl x:Class="SAP.Views.AllocationBuddy.AllocationBuddyRPGView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SAP.ViewModels"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:AllocationBuddyRPGViewModel}">

    <Grid Background="{StaticResource BackgroundBrush}">
        <!-- Full Screen Welcome Screen (shown when no data) -->
        <Grid Visibility="{Binding HasNoData, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#667eea" Offset="0"/>
                    <GradientStop Color="#764ba2" Offset="1"/>
                </LinearGradientBrush>
            </Grid.Background>
            
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" 
                            MaxWidth="550" Margin="24" MinHeight="400">
                    <!-- Icon -->
                    <Border Background="White" Width="100" Height="100" CornerRadius="50" 
                            HorizontalAlignment="Center" Margin="0,0,0,24">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="30" ShadowDepth="0" Opacity="0.3"/>
                        </Border.Effect>
                        <TextBlock Text="ðŸ“¦" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    
                    <!-- Title -->
                    <TextBlock Text="Allocation Buddy" FontSize="36" FontWeight="Bold"
                               Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,8"
                               TextWrapping="Wrap" TextAlignment="Center">
                        <TextBlock.Effect>
                            <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.3"/>
                        </TextBlock.Effect>
                    </TextBlock>
                    
                    <!-- Subtitle -->
                    <TextBlock Text="Smart inventory allocation made simple" FontSize="16"
                               Foreground="#CCFFFFFF" HorizontalAlignment="Center" Margin="0,0,0,32"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                    
                    <!-- Import Button -->
                    <Button Command="{Binding ImportCommand}" 
                            HorizontalAlignment="Center" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="White"/>
                                <Setter Property="Foreground" Value="#667eea"/>
                                <Setter Property="Padding" Value="32,14"/>
                                <Setter Property="FontSize" Value="16"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    CornerRadius="25" Padding="{TemplateBinding Padding}">
                                                <Border.Effect>
                                                    <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.2"/>
                                                </Border.Effect>
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F0F0F0"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¥" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Import Allocation File" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- OR Divider -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,24,0,20">
                        <Border Background="#40FFFFFF" Height="1" Width="60" VerticalAlignment="Center"/>
                        <TextBlock Text="OR" Foreground="#99FFFFFF" FontWeight="Medium" Margin="12,0" FontSize="12"/>
                        <Border Background="#40FFFFFF" Height="1" Width="60" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Paste Area -->
                    <Border Background="#15FFFFFF" CornerRadius="10" Padding="16" 
                            BorderBrush="#30FFFFFF" BorderThickness="2">
                        <StackPanel>
                            <TextBlock Text="ðŸ“‹ Paste Data from Excel" FontSize="14" FontWeight="SemiBold"
                                       Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                            <TextBlock Text="Copy cells from Excel and paste below (Store, Item, Qty columns)"
                                       FontSize="11" Foreground="#AAFFFFFF" HorizontalAlignment="Center" Margin="0,0,0,10"
                                       TextWrapping="Wrap" TextAlignment="Center"/>
                            <TextBox x:Name="PasteTextBox" 
                                     Height="100" 
                                     AcceptsReturn="True" 
                                     AcceptsTab="True"
                                     TextWrapping="Wrap"
                                     VerticalScrollBarVisibility="Auto"
                                     FontFamily="Consolas"
                                     FontSize="11"
                                     Padding="8"
                                     Text="{Binding PasteText, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Background" Value="White"/>
                                        <Setter Property="Foreground" Value="#333"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TextBox">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                        <ScrollViewer x:Name="PART_ContentHost"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                            <Button Command="{Binding ImportFromPasteTextCommand}" 
                                    HorizontalAlignment="Center" Margin="0,10,0,0" Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="White"/>
                                        <Setter Property="Foreground" Value="#667eea"/>
                                        <Setter Property="Padding" Value="20,8"/>
                                        <Setter Property="FontSize" Value="13"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="16" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#F0F0F0"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Import Pasted Data" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                    
                    <!-- Features -->
                    <WrapPanel HorizontalAlignment="Center" Margin="0,24,0,0">
                        <Border Background="#20FFFFFF" CornerRadius="8" Padding="12,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“Š" FontSize="16" Margin="0,0,6,0"/>
                                <TextBlock Text="Excel &amp; CSV" Foreground="White" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                        <Border Background="#20FFFFFF" CornerRadius="8" Padding="12,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸª" FontSize="16" Margin="0,0,6,0"/>
                                <TextBlock Text="Multi-Location" Foreground="White" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                        <Border Background="#20FFFFFF" CornerRadius="8" Padding="12,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“‹" FontSize="16" Margin="0,0,6,0"/>
                                <TextBlock Text="BC Transfer Ready" Foreground="White" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                    </WrapPanel>
                    
                    <!-- Supported formats -->
                    <TextBlock Text="Drag &amp; drop, import files, or paste directly from Excel" 
                               FontSize="12" Foreground="#99FFFFFF" HorizontalAlignment="Center" Margin="0,20,0,0"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Main Content (shown when has data) -->
        <Grid Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar / Header -->
        <Border Grid.Row="0" Style="{StaticResource ModernToolbar}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left side - Primary actions -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Command="{Binding ImportCommand}" Style="{StaticResource ModernButton}" Margin="0,0,6,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¥" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Import"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding PasteCommand}" Style="{StaticResource SecondaryButton}" Margin="0,0,6,0"
                            ToolTip="Paste data from Excel (Ctrl+V)">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“‹" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Paste"/>
                        </StackPanel>
                    </Button>

                    <!-- Export Dropdown -->
                    <Button x:Name="ExportButton" Style="{StaticResource SecondaryButton}" Margin="0,0,6,0" Click="ExportButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¤" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Export"/>
                            <TextBlock Text="â–¼" FontSize="8" Margin="6,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <Button.ContextMenu>
                            <ContextMenu x:Name="ExportContextMenu" 
                                         DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                <MenuItem Header="Export to Excel (.xlsx)" Command="{Binding ExportToExcelCommand}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="ðŸ“Š" FontSize="14"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Export to CSV (.csv)" Command="{Binding ExportToCsvCommand}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="ðŸ“‹" FontSize="14"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>

                    <Button Command="{Binding UndoDeactivateCommand}" Style="{StaticResource SecondaryButton}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="â†¶" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Undo"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Center - Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Command="{Binding ClearCommand}" Style="{StaticResource SecondaryButton}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="âœ–" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Clear Search"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding ClearDataCommand}" Style="{StaticResource DangerButton}" Margin="6,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ—‘" FontSize="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Clear Data"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Right side - Item count badge -->
                <Border Grid.Column="2" Background="{StaticResource PrimaryBrush}" CornerRadius="12"
                        Padding="12,6" VerticalAlignment="Center">
                    <TextBlock Text="{Binding TotalEntries, StringFormat='ðŸ“¦ {0} items'}"
                               Foreground="White" FontWeight="SemiBold" FontSize="13"/>
                </Border>
            </Grid>
        </Border>

        <!-- Search and Filter Bar -->
        <Border Grid.Row="1" Background="{StaticResource SurfaceBrush}" BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,0,0,1" Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search Box -->
                <TextBox Grid.Column="0" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBox.Style>
                        <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush Stretch="None" AlignmentX="Left">
                                                <VisualBrush.Visual>
                                                    <TextBlock Text="ðŸ” Search by item number, description, or location..."
                                                             Foreground="{StaticResource TextTertiaryBrush}" Margin="12,0,0,0"/>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <!-- Location Count Badge -->
                <Border Grid.Column="1" Background="{StaticResource AccentBrush}" CornerRadius="12"
                        Padding="12,6" VerticalAlignment="Center">
                    <TextBlock Text="{Binding LocationsCount, StringFormat='ðŸ“ {0} locations'}"
                               Foreground="White" FontWeight="SemiBold" FontSize="13"/>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Item Totals Summary - Collapsible section -->
            <Border Grid.Row="0"
                    Background="{StaticResource BackgroundBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8"
                    Visibility="{Binding ItemTotals.Count, Converter={StaticResource CountToVisibility}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header Row -->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Left side: Title and count -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="ðŸ“Š" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Item Totals" FontWeight="SemiBold" FontSize="13"
                                       Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                            <Border Background="{StaticResource PrimaryBrush}" CornerRadius="10" 
                                    Padding="8,2" Margin="10,0,0,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding ItemTotals.Count, StringFormat='{}{0} items'}"
                                           FontSize="11" FontWeight="SemiBold" Foreground="White"/>
                            </Border>
                        </StackPanel>
                        
                        <!-- Right side: Toggle button -->
                        <ToggleButton x:Name="ItemTotalsToggle" Grid.Column="1" IsChecked="False" Cursor="Hand">
                            <ToggleButton.Style>
                                <Style TargetType="ToggleButton">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border x:Name="Bd" Background="{StaticResource SurfaceBrush}" 
                                                        BorderBrush="{StaticResource BorderBrush}"
                                                        BorderThickness="1" CornerRadius="4" Padding="10,6">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock x:Name="BtnText" Text="Show" FontSize="12" 
                                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                                                        <TextBlock x:Name="Arrow" Text="â–¼" FontSize="9"
                                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsChecked" Value="True">
                                                        <Setter TargetName="BtnText" Property="Text" Value="Hide"/>
                                                        <Setter TargetName="Arrow" Property="Text" Value="â–²"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Bd" Property="Background" Value="{StaticResource BackgroundBrush}"/>
                                                        <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                                        <Setter TargetName="BtnText" Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                                                        <Setter TargetName="Arrow" Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ToggleButton.Style>
                        </ToggleButton>
                    </Grid>
                    
                    <!-- Collapsible Content -->
                    <Border Grid.Row="1" MaxHeight="150" Margin="0,10,0,0"
                            Visibility="{Binding IsChecked, ElementName=ItemTotalsToggle, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Grid>
                            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                <ItemsControl ItemsSource="{Binding ItemTotals}" Margin="0,0,0,4">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource SurfaceBrush}"
                                                    BorderBrush="{StaticResource BorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="4"
                                                    Padding="8,4"
                                                    Margin="0,0,8,6">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Description}" 
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               MaxWidth="120"
                                                               TextTrimming="CharacterEllipsis"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding ItemNumber, StringFormat=' ({0})'}" 
                                                               FontSize="10"
                                                               Foreground="{StaticResource TextTertiaryBrush}"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,6,0"/>
                                                    <Border Background="{StaticResource PrimaryBrush}"
                                                            CornerRadius="3"
                                                            Padding="6,2">
                                                        <TextBlock Text="{Binding TotalQuantity, StringFormat='Ã—{0}'}"
                                                                   FontWeight="Bold"
                                                                   FontSize="11"
                                                                   Foreground="White"/>
                                                    </Border>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                            <!-- Bottom shadow gradient for scroll indication -->
                            <Border VerticalAlignment="Bottom" Height="20" IsHitTestVisible="False">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                        <GradientStop Color="Transparent" Offset="0"/>
                                        <GradientStop Color="#18000000" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                            </Border>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Item Pool - Top Section -->
            <Border Grid.Row="1"
                    Background="{StaticResource SurfaceBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="16">
                <DockPanel>
                    <!-- Pool Header -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¦" FontSize="20" Margin="0,0,8,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Item Pool" FontWeight="Bold" FontSize="18"
                                       Foreground="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ItemPool.Count, StringFormat=' ({0} items)'}"
                                       FontSize="14"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       VerticalAlignment="Center"
                                       Margin="8,0,0,0"/>
                        </StackPanel>
                    </Grid>

                    <!-- Import Results -->
                    <ItemsControl DockPanel.Dock="Top" ItemsSource="{Binding FileImportResults}" Margin="0,0,0,12">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="8,4"
                                        Margin="0,0,8,4"
                                        Background="{StaticResource BackgroundBrush}"
                                        CornerRadius="4"
                                        BorderBrush="{StaticResource BorderBrush}"
                                        BorderThickness="1">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding FileName}"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextPrimaryBrush}"
                                                   Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding Count, StringFormat='âœ“ {0}'}"
                                                   Foreground="{StaticResource SuccessBrush}"
                                                   FontSize="12"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Pool Items - Scrollable Grid Layout with fixed max height -->
                    <Grid>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                      HorizontalScrollBarVisibility="Disabled"
                                      MaxHeight="280">
                            <ItemsControl ItemsSource="{Binding ItemPool}" Margin="0,0,0,4">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource BackgroundBrush}"
                                                BorderBrush="{StaticResource BorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="10"
                                                Margin="0,0,8,8"
                                                Width="260">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Description}"
                                                               TextTrimming="CharacterEllipsis"
                                                               FontWeight="SemiBold"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               MaxWidth="140"/>
                                                    <TextBlock Text="{Binding ItemNumber}"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                           FontSize="10"
                                                           Margin="0,2,0,0"/>
                                            </StackPanel>

                                            <Border Grid.Column="1"
                                                    Background="{StaticResource AccentBrush}"
                                                    CornerRadius="4"
                                                    Padding="8,4"
                                                    VerticalAlignment="Center"
                                                    Margin="8,0">
                                                <TextBlock Text="{Binding Quantity, StringFormat='Ã—{0}'}"
                                                           Foreground="White"
                                                           FontWeight="Bold"
                                                           FontSize="12"
                                                           HorizontalAlignment="Center"/>
                                            </Border>

                                            <Button Grid.Column="2"
                                                    Content="â†’"
                                                    Command="{Binding DataContext.SelectAndMoveFromPoolCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource PrimaryButton}"
                                                    Width="32"
                                                    Height="32"
                                                    Padding="0"
                                                    FontSize="14"
                                                    ToolTip="Allocate to location..."/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <!-- Bottom shadow gradient for scroll indication -->
                        <Border VerticalAlignment="Bottom" Height="20" IsHitTestVisible="False">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                    <GradientStop Color="Transparent" Offset="0"/>
                                    <GradientStop Color="#18000000" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                        </Border>
                    </Grid>
                </DockPanel>
            </Border>

            <!-- Locations Section - Bottom -->
            <Grid Grid.Row="2">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding FilteredLocationAllocations}" Margin="16">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource SurfaceBrush}"
                                        BorderBrush="{StaticResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="16"
                                        Margin="0,0,0,12">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.1"/>
                                    </Border.Effect>
                                    <StackPanel>
                                        <Grid Margin="0,0,0,12">
                                            <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Orientation="Horizontal" Grid.Column="0">
                                            <TextBlock Text="ðŸ“" FontSize="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayLocation}" FontWeight="Bold" FontSize="16"
                                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                                            <TextBlock Text="{Binding Items.Count, StringFormat=' ({0})'}"
                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                       FontSize="14"
                                                       Margin="4,0,0,0"/>
                                        </StackPanel>

                                        <Button Grid.Column="1"
                                                Command="{Binding DataContext.CopyLocationToClipboardCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource SecondaryButton}"
                                                Padding="8,4"
                                                Margin="0,0,8,0"
                                                ToolTip="Copy items for Business Central transfer order">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="ðŸ“‹" FontSize="12" Margin="0,0,4,0"/>
                                                <TextBlock Text="Copy for BC" FontSize="11"/>
                                            </StackPanel>
                                        </Button>

                                        <Button Grid.Column="2"
                                                Command="{Binding DataContext.DeactivateStoreCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource DangerButton}"
                                                Padding="8,4">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="âœ–" FontSize="12" Margin="0,0,4,0"/>
                                                <TextBlock Text="Deactivate" FontSize="11"/>
                                            </StackPanel>
                                        </Button>
                                    </Grid>

                                    <ItemsControl ItemsSource="{Binding Items}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{StaticResource BackgroundBrush}"
                                                        CornerRadius="6"
                                                        Padding="10"
                                                        Margin="0,0,0,8">
                                                    <Grid VerticalAlignment="Center">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="8"/>
                                                            <ColumnDefinition Width="36"/>
                                                            <ColumnDefinition Width="50"/>
                                                            <ColumnDefinition Width="36"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel Grid.Column="0">
                                                            <TextBlock Text="{Binding Description}"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       FontWeight="Medium"
                                                                       Foreground="{StaticResource TextPrimaryBrush}"/>
                                                            <TextBlock Text="{Binding ItemNumber}"
                                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                                       FontSize="11"
                                                                       Margin="0,2,0,0"/>
                                                        </StackPanel>

                                                        <Button Grid.Column="3"
                                                                Content="â†"
                                                                Command="{Binding DataContext.RemoveOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{StaticResource SecondaryButton}"
                                                                Width="32"
                                                                Height="32"
                                                                Padding="0"
                                                                FontSize="14"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                ToolTip="Send to pool"/>

                                                        <TextBlock Grid.Column="4"
                                                                   Text="{Binding Quantity}"
                                                                   VerticalAlignment="Center"
                                                                   HorizontalAlignment="Center"
                                                                   FontWeight="Bold"
                                                                   FontSize="16"
                                                                   Foreground="{StaticResource PrimaryBrush}"/>

                                                        <Button Grid.Column="5"
                                                                Content="â†’"
                                                                Command="{Binding DataContext.AddOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{StaticResource SecondaryButton}"
                                                                Width="32"
                                                                Height="32"
                                                                Padding="0"
                                                                FontSize="14"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                ToolTip="Get from pool"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
            <!-- Top shadow gradient for scroll indication -->
            <Border VerticalAlignment="Top" Height="16" IsHitTestVisible="False">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#18000000" Offset="0"/>
                        <GradientStop Color="Transparent" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
            </Border>
        </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Style="{StaticResource ModernStatusBar}">
            <StatusBar.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                    </Grid>
                </ItemsPanelTemplate>
            </StatusBar.ItemsPanel>

            <StatusBarItem Grid.Column="0">
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
            </StatusBarItem>

            <StatusBarItem Grid.Column="1">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ’¾" FontSize="14" Margin="0,0,8,0"/>
                    <TextBlock Text="Ready" VerticalAlignment="Center" Foreground="{StaticResource SuccessBrush}"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
        </Grid>
    </Grid>
</UserControl>