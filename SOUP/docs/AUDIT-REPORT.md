# SOUP — Code Audit Summary (Partial)

Date: 2026-01-13

## Scope
- Focus: security and native interop hardening, secret handling, minimal code-quality review of the `SOUP` WPF desktop app.
- Actions taken: repository scan for high-risk patterns, applied targeted fixes, rebuilt solution, dependency vuln-scan.

## High-level Summary
- Built successfully using a user-provided local .NET SDK.
- Applied multiple security and interop hardening patches to avoid 32/64-bit truncation, reduce plaintext secret exposure, and improve native-call diagnostics.
- No vulnerable NuGet packages reported by `dotnet list package --vulnerable` (given current feeds).

## Findings (Prioritized)
1. Plaintext secrets in UI and configuration
   - Risk: credentials exposed in managed strings and bound UI fields.
   - Status: mitigated. Secrets moved to `SecureString` in `ExternalConnectionConfig` and `PasswordBox` usage added in the UI.
2. Unsafe P/Invoke usage (32/64-bit truncation and missing `SetLastError`)
   - Risk: crashes, wrong behavior on x64 and poor error diagnostics.
   - Status: mitigated. Added pointer-size-safe wrappers in `Helpers/NativeMethods.cs` and applied `SetLastError`/`CharSet` to various DllImport declarations.
3. Native API error-checking
   - Risk: native calls (DWM, Shell, Win32) returned values not checked, causing silent failures.
   - Status: improved. `DwmSetWindowAttribute` call now checks and logs failures.
4. Raw printer helper resource handling
   - Risk: unmanaged memory and handles could leak or cause security issues.
   - Status: previously hardened (validated and cleaned up).

## Changes Applied (non-exhaustive)
- `src/Views/ExternalDataSettingsView.xaml` and `.xaml.cs` — replaced plaintext bindings with `PasswordBox` and SecureString handling.
- `src/Services/External/ExternalConnectionConfig.cs` — store DPAPI-decrypted secrets into `SecureString` and avoid long-lived plaintext.
- `src/Helpers/NativeMethods.cs` — add pointer-size-safe Get/SetWindowLongPtr wrappers; add `SetLastError` on common imports.
- `src/Windows/OrderLogWidgetWindow.xaml.cs` — use `NativeMethods` wrappers and add `SetLastError` on SHAppBarMessage/RegisterWindowMessage.
- `src/Services/DialogService.cs` — added `SetLastError` to `DwmSetWindowAttribute` and checked result with logging.
- `src/Helpers/RawPrinterHelper.cs` — added validation, Win32 error checks and ensured unmanaged cleanup.
- `src/Services/SpotifyService.cs` — added `SetLastError` to `keybd_event` import.

(See code changes committed locally in working directory.)

## Recommendations (next steps)
- Create PR(s) for these patches with small, focused commits and include the audit report.
- Add unit/integration tests around credential loading, DPAPI migration, and `ExternalConnectionConfig` to assert no plaintext remains in long-lived memory.
- Add runtime telemetry/logging for native-call failures (where acceptable) to capture `Marshal.GetLastWin32Error()` when `SetLastError` is used.
- Complete a code-quality pass: identify duplicate logic, long methods, and add selective refactorings with tests.
- Security hardening: consider using Windows Credential Manager or secure platform-backed stores instead of rolling storage; review DPAPI usage for roaming/multi-account scenarios.

## Suggested PR checklist
- Each changed file in a focused commit
- Unit tests for credential flow and DPAPI decrypt
- Update `CHANGELOG.md` with a short security/hardening entry
- CI: run `dotnet build`, `dotnet format` (if used), and tests

## Current Status / Next Actions
- `dotnet build` succeeds after applied fixes.
- Vulnerability scan shows no vulnerable packages on current feeds.

Next actions I can take now (pick one):
- Create a branch and PR with the applied patches.
- Add unit tests for credential and DPAPI flows.
- Continue a deeper code-quality audit.

---

Report generated by the audit agent. If you'd like this expanded into a full formal report (risk scoring, file-by-file diffs, or exported PDF), tell me which format and I will produce it.
