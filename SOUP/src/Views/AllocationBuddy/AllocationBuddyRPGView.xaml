<UserControl x:Class="SOUP.Views.AllocationBuddy.AllocationBuddyRPGView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SOUP.ViewModels"
             xmlns:converters="clr-namespace:SOUP.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:AllocationBuddyRPGViewModel}">

    <UserControl.Resources>
        <!-- Converters -->
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
        
        <!-- Indigo/Purple accent for AllocationBuddy -->
        <Color x:Key="AllocationAccentColor">#6366f1</Color>
        <Color x:Key="AllocationAccentLightColor">#818cf8</Color>
        <SolidColorBrush x:Key="AllocationAccentBrush" Color="{StaticResource AllocationAccentColor}"/>
        <SolidColorBrush x:Key="AllocationAccentLightBrush" Color="{StaticResource AllocationAccentLightColor}"/>
        
        <!-- Sidebar Navigation Style -->
        <Style x:Key="SidebarNavItem" TargetType="RadioButton">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="Margin" Value="8,2"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Bg" Background="Transparent" CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="#1e1b4b"/>
                                <Setter Property="Foreground" Value="{StaticResource AllocationAccentLightBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Sidebar Action Button Style (for non-toggle actions) -->
        <Style x:Key="SidebarActionItem" TargetType="Button">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="Margin" Value="8,2"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bg" Background="Transparent" CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Left"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="#1e1b4b"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Sidebar Navigation Style for ToggleButton -->
        <Style x:Key="SidebarNavToggle" TargetType="ToggleButton">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="Margin" Value="8,2"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bg" Background="Transparent" CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bg" Property="Background" Value="#1e1b4b"/>
                                <Setter Property="Foreground" Value="{StaticResource AllocationAccentLightBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <UserControl.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource FadeInStoryboard}"/>
        </EventTrigger>
    </UserControl.Triggers>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <!-- Full Screen Welcome Screen (shown when no data) -->
        <Grid Visibility="{Binding HasNoData, Converter={StaticResource BooleanToVisibilityConverter}}"
              Background="{DynamicResource WelcomeScreenGradientBrush}">
            
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" 
                            MaxWidth="550" Margin="24" MinHeight="400">
                    <!-- Icon -->
                    <Border Width="100" Height="100" CornerRadius="28" 
                            HorizontalAlignment="Center" Margin="0,0,0,24">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#6366f1" Offset="0"/>
                                <GradientStop Color="#8b5cf6" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="40" ShadowDepth="0" Opacity="0.6" Color="#6366f1"/>
                        </Border.Effect>
                        <TextBlock Text="ðŸ“Š" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    
                    <!-- Title -->
                    <TextBlock Text="Allocation Buddy" FontSize="36" FontWeight="Bold"
                               Foreground="{DynamicResource SplashTitleBrush}" HorizontalAlignment="Center" Margin="0,0,0,8"
                               TextWrapping="Wrap" TextAlignment="Center">
                        <TextBlock.Effect>
                            <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.3"/>
                        </TextBlock.Effect>
                    </TextBlock>
                    
                    <!-- Subtitle -->
                    <TextBlock Text="Smart inventory allocation made simple" FontSize="16"
                               Foreground="{DynamicResource TextTertiaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,32"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                    
                    <!-- Import Button -->
                    <Button Command="{Binding ImportCommand}" 
                            HorizontalAlignment="Center" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Padding" Value="32,14"/>
                                <Setter Property="FontSize" Value="16"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Bg" CornerRadius="14" Padding="{TemplateBinding Padding}">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#6366f1" Offset="0"/>
                                                        <GradientStop Color="#8b5cf6" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                                <Border.Effect>
                                                    <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.4" Color="#6366f1"/>
                                                </Border.Effect>
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bg" Property="Background">
                                                        <Setter.Value>
                                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                <GradientStop Color="#818cf8" Offset="0"/>
                                                                <GradientStop Color="#a78bfa" Offset="1"/>
                                                            </LinearGradientBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“¥" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Import Allocation File" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- OR Divider -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,24,0,20">
                        <Border Background="{DynamicResource SurfaceHoverBrush}" Height="1" Width="60" VerticalAlignment="Center"/>
                        <TextBlock Text="OR" Foreground="{DynamicResource TextDisabledBrush}" FontWeight="Medium" Margin="12,0" FontSize="12"/>
                        <Border Background="{DynamicResource SurfaceHoverBrush}" Height="1" Width="60" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Paste Area -->
                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="16" Padding="20" 
                            BorderBrush="{DynamicResource SurfaceHoverBrush}" BorderThickness="1">
                        <StackPanel>
                            <TextBlock Text="ðŸ“‹ Paste Data from Excel" FontSize="14" FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                            <TextBlock Text="Copy cells from Excel and paste below (Store, Item, Qty columns)"
                                       FontSize="11" Foreground="{DynamicResource TextTertiaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,10"
                                       TextWrapping="Wrap" TextAlignment="Center"/>
                            <TextBox x:Name="PasteTextBox" 
                                     Height="100" 
                                     AcceptsReturn="True" 
                                     AcceptsTab="True"
                                     TextWrapping="Wrap"
                                     VerticalScrollBarVisibility="Auto"
                                     FontFamily="Consolas"
                                     FontSize="11"
                                     Padding="8"
                                     Text="{Binding PasteText, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="CaretBrush" Value="{DynamicResource TextPrimaryBrush}"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TextBox">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="8" Padding="{TemplateBinding Padding}">
                                                        <ScrollViewer x:Name="PART_ContentHost"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                            <Button Command="{Binding ImportFromPasteTextCommand}" 
                                    HorizontalAlignment="Center" Margin="0,12,0,0" Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="Padding" Value="20,10"/>
                                        <Setter Property="FontSize" Value="13"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border x:Name="Bg" Background="{DynamicResource SurfaceActiveBrush}" 
                                                            CornerRadius="10" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="Bg" Property="Background" Value="{DynamicResource TextDisabledBrush}"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Import Pasted Data" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                    
                    <!-- Features -->
                    <WrapPanel HorizontalAlignment="Center" Margin="0,24,0,0">
                        <Border Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="10" Padding="14,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“Š" FontSize="16" Margin="0,0,8,0"/>
                                <TextBlock Text="Excel &amp; CSV" Foreground="{DynamicResource TextSecondaryBrush}" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                        <Border Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="10" Padding="14,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸª" FontSize="16" Margin="0,0,8,0"/>
                                <TextBlock Text="Multi-Location" Foreground="{DynamicResource TextSecondaryBrush}" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                        <Border Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="10" Padding="14,10" Margin="4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“‹" FontSize="16" Margin="0,0,8,0"/>
                                <TextBlock Text="BC Transfer Ready" Foreground="{DynamicResource TextSecondaryBrush}" FontWeight="Medium" FontSize="13"/>
                            </StackPanel>
                        </Border>
                    </WrapPanel>
                    
                    <!-- Supported formats -->
                    <TextBlock Text="Drag &amp; drop, import files, or paste directly from Excel" 
                               FontSize="12" Foreground="{DynamicResource TextDisabledBrush}" HorizontalAlignment="Center" Margin="0,20,0,0"
                               TextWrapping="Wrap" TextAlignment="Center"/>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Main Content with Sidebar (shown when has data) -->
        <Grid Visibility="{Binding HasData, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="220"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Sidebar -->
            <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" BorderBrush="{DynamicResource SurfaceHoverBrush}" BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <StackPanel Grid.Row="0" Margin="16,20,16,16">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <Border Width="36" Height="36" CornerRadius="10" Margin="0,0,12,0">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#6366f1" Offset="0"/>
                                        <GradientStop Color="#8b5cf6" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <TextBlock Text="ðŸ“Š" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Allocation" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBlock Text="Buddy" FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>

                    <!-- Stats Summary -->
                    <Border Grid.Row="1" Background="{DynamicResource BackgroundBrush}" CornerRadius="12" Margin="12,0,12,12" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,0,8">
                                <TextBlock Text="{Binding TotalEntries, FallbackValue=0}" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource PrimaryLightBrush}"/>
                                <TextBlock Text="Total Items" FontSize="10" Foreground="{DynamicResource TextTertiaryBrush}"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,0,8">
                                <TextBlock Text="{Binding LocationsCount, FallbackValue=0}" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource SuccessLightBrush}"/>
                                <TextBlock Text="Locations" FontSize="10" Foreground="{DynamicResource TextTertiaryBrush}"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="0" Grid.Row="1">
                                <TextBlock Text="{Binding ItemPool.Count, FallbackValue=0}" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource WarningLightBrush}"/>
                                <TextBlock Text="In Pool" FontSize="10" Foreground="{DynamicResource TextTertiaryBrush}"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Grid.Row="1">
                                <TextBlock Text="{Binding ItemTotals.Count, FallbackValue=0}" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource WarningBrush}"/>
                                <TextBlock Text="Unique Items" FontSize="10" Foreground="{DynamicResource TextTertiaryBrush}"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Navigation -->
                    <StackPanel Grid.Row="2" Margin="0,8,0,0">
                        <TextBlock Text="ACTIONS" FontSize="10" FontWeight="SemiBold" 
                                   Foreground="{DynamicResource TextDisabledBrush}" Margin="20,0,0,8"/>
                        
                        <Button x:Name="NavImport" Style="{StaticResource SidebarActionItem}" 
                                Command="{Binding ImportCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“¥" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Import File" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding PasteCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“‹" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Paste Data" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Separator Background="{DynamicResource SurfaceHoverBrush}" Margin="16,12"/>
                        
                        <TextBlock Text="EXPORT" FontSize="10" FontWeight="SemiBold" 
                                   Foreground="{DynamicResource TextDisabledBrush}" Margin="20,0,0,8"/>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding ExportToExcelCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“Š" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Export Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding ExportToCsvCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“„" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Export CSV" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Separator Background="{DynamicResource SurfaceHoverBrush}" Margin="16,12"/>
                        
                        <TextBlock Text="ARCHIVE" FontSize="10" FontWeight="SemiBold" 
                                   Foreground="{DynamicResource TextDisabledBrush}" Margin="20,0,0,8"/>
                        
                        <ToggleButton Style="{StaticResource SidebarNavToggle}"
                                      IsChecked="{Binding IsArchivePanelOpen, Mode=TwoWay}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“š" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="View Archives" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding Archives.Count, StringFormat=' ({0})'}" 
                                           FontSize="11" Foreground="{DynamicResource TextTertiaryBrush}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ToggleButton>
                        
                        <Separator Background="{DynamicResource SurfaceHoverBrush}" Margin="16,12"/>
                        
                        <TextBlock Text="VIEW" FontSize="10" FontWeight="SemiBold" 
                                   Foreground="{DynamicResource TextDisabledBrush}" Margin="20,0,0,8"/>

                        <RadioButton Style="{StaticResource SidebarNavItem}" GroupName="ViewMode"
                                     IsChecked="{Binding IsStoreView, Mode=OneWay}"
                                     Command="{Binding SetViewModeCommand}" CommandParameter="stores">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸª" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="By Store" VerticalAlignment="Center"/>
                            </StackPanel>
                        </RadioButton>
                        
                        <RadioButton Style="{StaticResource SidebarNavItem}" GroupName="ViewMode"
                                     IsChecked="{Binding IsItemView, Mode=OneWay}"
                                     Command="{Binding SetViewModeCommand}" CommandParameter="items">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“¦" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="By Item" VerticalAlignment="Center"/>
                            </StackPanel>
                        </RadioButton>
                        
                        <Separator Background="{DynamicResource SurfaceHoverBrush}" Margin="16,12"/>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding UndoDeactivateCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="â†¶" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Undo" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding ClearCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="âœ–" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Clear Search" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Bottom Actions -->
                    <StackPanel Grid.Row="3" Margin="8,0,8,12">
                        <Separator Background="{DynamicResource SurfaceHoverBrush}" Margin="8,0,8,12"/>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding OpenSettingsCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="âš™ï¸" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Settings" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SidebarActionItem}"
                                Command="{Binding ClearDataCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ—‘ï¸" FontSize="16" Margin="0,0,12,0"/>
                                <TextBlock Text="Clear Data" VerticalAlignment="Center" Foreground="{DynamicResource DangerBrush}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Archive Panel (Slide-in from right) -->
            <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                    HorizontalAlignment="Right" Width="320"
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1,0,0,0"
                    Panel.ZIndex="10"
                    Visibility="{Binding IsArchivePanelOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Panel Header -->
                    <Border Grid.Row="0" Background="{DynamicResource BackgroundBrush}" Padding="16,12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ“š" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Past Allocations" FontSize="16" FontWeight="Bold" 
                                           Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <Button Grid.Column="1" Content="âœ•" Cursor="Hand"
                                    Command="{Binding ViewArchivesCommand}"
                                    Click="CloseArchivePanel_Click">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                        <Setter Property="FontSize" Value="16"/>
                                        <Setter Property="Padding" Value="8,4"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <!-- Archive List -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="12">
                        <ItemsControl ItemsSource="{Binding Archives}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource BackgroundBrush}" CornerRadius="10" 
                                            Margin="0,0,0,8" Padding="12">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <!-- Name -->
                                            <TextBlock Grid.Row="0" Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                            
                                            <!-- Date and Stats -->
                                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding DisplayDate}" FontSize="11" 
                                                           Foreground="{DynamicResource TextTertiaryBrush}"/>
                                                <TextBlock Text=" â€¢ " Foreground="{DynamicResource TextDisabledBrush}"/>
                                                <TextBlock Text="{Binding Summary}" FontSize="11" 
                                                           Foreground="{DynamicResource TextTertiaryBrush}"/>
                                            </StackPanel>
                                            
                                            <!-- Notes -->
                                            <TextBlock Grid.Row="2" Text="{Binding Notes}" FontSize="11" 
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       TextTrimming="CharacterEllipsis" Margin="0,4,0,0"
                                                       Visibility="{Binding Notes, Converter={StaticResource NullToVisibilityConverter}}"/>
                                            
                                            <!-- Actions -->
                                            <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0">
                                                <Button Content="Load" Command="{Binding LoadCommand}" Cursor="Hand" Margin="0,0,8,0">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Background" Value="#6366f1"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                            <Setter Property="Padding" Value="12,6"/>
                                                            <Setter Property="FontSize" Value="11"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                            <Setter Property="BorderThickness" Value="0"/>
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border x:Name="Bg" Background="{TemplateBinding Background}" 
                                                                                CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter TargetName="Bg" Property="Background" Value="#818cf8"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                                <Button Content="Delete" Command="{Binding DeleteCommand}" Cursor="Hand">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                                                            <Setter Property="Foreground" Value="#ef4444"/>
                                                            <Setter Property="Padding" Value="12,6"/>
                                                            <Setter Property="FontSize" Value="11"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                            <Setter Property="BorderThickness" Value="0"/>
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border x:Name="Bg" Background="{TemplateBinding Background}" 
                                                                                CornerRadius="6" Padding="{TemplateBinding Padding}">
                                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter TargetName="Bg" Property="Background" Value="#fecaca"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    
                    <!-- Empty State -->
                    <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                                Visibility="{Binding Archives.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                        <TextBlock Text="ðŸ“š" FontSize="40" HorizontalAlignment="Center" Margin="0,0,0,12"/>
                        <TextBlock Text="No archives yet" FontSize="14" FontWeight="Medium"
                                   Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                        <TextBlock Text="Archive your current allocation to save it for later" 
                                   FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}" 
                                   HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center" MaxWidth="200"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Column="1" Background="{DynamicResource BackgroundBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header with Search -->
                <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" Padding="20,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Search Box -->
                        <Border Grid.Column="0" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="10" Padding="12,0" MaxWidth="500" HorizontalAlignment="Left">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="ðŸ”" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBox Grid.Column="1" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                         Background="Transparent" BorderThickness="0" Foreground="{DynamicResource TextPrimaryBrush}"
                                         VerticalAlignment="Center" Padding="0,8" FontSize="14"
                                         CaretBrush="{DynamicResource TextPrimaryBrush}">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Style.Triggers>
                                                <Trigger Property="Text" Value="">
                                                    <Setter Property="Background">
                                                        <Setter.Value>
                                                            <VisualBrush Stretch="None" AlignmentX="Left">
                                                                <VisualBrush.Visual>
                                                                    <TextBlock Text="Search items or locations..." Foreground="{DynamicResource TextTertiaryBrush}"/>
                                                                </VisualBrush.Visual>
                                                            </VisualBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>
                            </Grid>
                        </Border>

                        <!-- Badges -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Border Background="{DynamicResource PrimaryBrush}" CornerRadius="10" Padding="12,6" Margin="0,0,8,0">
                                <TextBlock Text="{Binding TotalEntries, StringFormat='ðŸ“¦ {0} items'}"
                                           Foreground="{DynamicResource TextOnPrimaryBrush}" FontWeight="SemiBold" FontSize="12"/>
                            </Border>
                            <Border Background="{DynamicResource SecondaryBrush}" CornerRadius="10" Padding="12,6">
                                <TextBlock Text="{Binding LocationsCount, StringFormat='ðŸ“ {0} locations'}"
                                           Foreground="{DynamicResource TextOnPrimaryBrush}" FontWeight="SemiBold" FontSize="12"/>
                            </Border>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Item Pool - Top Section -->
                <Border Grid.Row="1"
                        Background="{DynamicResource SurfaceBrush}"
                        BorderBrush="{DynamicResource SurfaceHoverBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="16">
                    <DockPanel>
                        <!-- Pool Header -->
                        <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="ðŸ“¦" FontSize="20" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Item Pool" FontWeight="Bold" FontSize="18"
                                           Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ItemPoolCount, StringFormat=' ({0} in pool)'}"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Margin="8,0,0,0"/>
                                <TextBlock Text="{Binding ItemTotals.Count, StringFormat=' â€¢ {0} unique items'}"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center"
                                           Margin="4,0,0,0"/>
                            </StackPanel>
                        </Grid>

                        <!-- Import Results -->
                        <ItemsControl DockPanel.Dock="Top" ItemsSource="{Binding FileImportResults}" Margin="0,0,0,12">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="8,4"
                                            Margin="0,0,8,4"
                                            Background="{DynamicResource SurfaceHoverBrush}"
                                            CornerRadius="6"
                                            BorderBrush="{DynamicResource SurfaceActiveBrush}"
                                            BorderThickness="1">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding FileName}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding Count, StringFormat='âœ“ {0}'}"
                                                       Foreground="{DynamicResource SuccessLightBrush}"
                                                       FontSize="12"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Pool Items - Scrollable Grid Layout with fixed max height -->
                        <Grid>
                            <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                          HorizontalScrollBarVisibility="Disabled"
                                          MaxHeight="200">
                                <ItemsControl ItemsSource="{Binding ItemTotals}" Margin="0,0,0,4">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderThickness="1"
                                                    CornerRadius="8"
                                                    Padding="10"
                                                    Margin="0,0,8,8"
                                                    Width="260">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
                                                        <Setter Property="BorderBrush" Value="{DynamicResource SurfaceActiveBrush}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasPoolItems}" Value="True">
                                                                <Setter Property="Background" Value="#2d1f4d"/>
                                                                <Setter Property="BorderBrush" Value="#8b5cf6"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Description}"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   FontWeight="SemiBold"
                                                                   FontSize="12"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   MaxWidth="160"/>
                                                        <TextBlock Text="{Binding ItemNumber}"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                                   FontSize="10"
                                                                   Margin="0,2,0,0"/>
                                                    </StackPanel>

                                                    <Border Grid.Column="1"
                                                            CornerRadius="6"
                                                            Padding="8,4"
                                                            VerticalAlignment="Center"
                                                            Margin="8,0,0,0">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Background" Value="{DynamicResource SurfaceActiveBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasPoolItems}" Value="True">
                                                                        <Setter Property="Background" Value="#8b5cf6"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Foreground="{DynamicResource TextOnPrimaryBrush}" FontWeight="Bold" FontSize="12">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Text" Value="{Binding PoolQuantity, StringFormat='{}{0}'}"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding HasPoolItems}" Value="True">
                                                                                <Setter Property="Text" Value="{Binding PoolQuantity, StringFormat='Ã—{0}'}"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <TextBlock Text="{Binding TotalQuantity, StringFormat=' / {0}'}"
                                                                       Foreground="{DynamicResource SecondaryLightBrush}"
                                                                       FontWeight="Normal"
                                                                       FontSize="11"
                                                                       VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </DockPanel>
                </Border>

                <!-- Locations Section - By Store (default view) -->
                <Grid Grid.Row="2" Visibility="{Binding IsStoreView, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredLocationAllocations}" Margin="16">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Vertical"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource SurfaceHoverBrush}"
                                            BorderThickness="1"
                                            CornerRadius="12"
                                            Padding="16"
                                            Margin="0,0,0,12">
                                        <StackPanel>
                                            <Grid Margin="0,0,0,12">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Orientation="Horizontal" Grid.Column="0">
                                                    <TextBlock Text="ðŸ“" FontSize="18" Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding DisplayLocation}" FontWeight="Bold" FontSize="16"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding Items.Count, StringFormat=' ({0})'}"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               FontSize="14"
                                                               Margin="4,0,0,0"/>
                                                </StackPanel>

                                                <Button Grid.Column="1"
                                                        Command="{Binding DataContext.CopyLocationToClipboardCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource SecondaryButton}"
                                                        Padding="8,4"
                                                        Margin="0,0,8,0"
                                                        ToolTip="Copy items for Business Central transfer order">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="ðŸ“‹" FontSize="12" Margin="0,0,4,0"/>
                                                        <TextBlock Text="Copy for BC" FontSize="11"/>
                                                    </StackPanel>
                                                </Button>

                                                <Button Grid.Column="2"
                                                        Command="{Binding DataContext.DeactivateStoreCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource DangerButton}"
                                                        Padding="8,4">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="âœ–" FontSize="12" Margin="0,0,4,0"/>
                                                        <TextBlock Text="Deactivate" FontSize="11"/>
                                                    </StackPanel>
                                                </Button>
                                            </Grid>

                                            <ItemsControl ItemsSource="{Binding Items}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{DynamicResource SurfaceHoverBrush}"
                                                                CornerRadius="8"
                                                                Padding="10"
                                                                Margin="0,0,0,8">
                                                            <Grid VerticalAlignment="Center">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="100"/>
                                                                    <ColumnDefinition Width="8"/>
                                                                    <ColumnDefinition Width="36"/>
                                                                    <ColumnDefinition Width="50"/>
                                                                    <ColumnDefinition Width="36"/>
                                                                </Grid.ColumnDefinitions>

                                                                <StackPanel Grid.Column="0">
                                                                    <TextBlock Text="{Binding Description}"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               FontWeight="Medium"
                                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                                    <TextBlock Text="{Binding ItemNumber}"
                                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                                               FontSize="11"
                                                                               Margin="0,2,0,0"/>
                                                                </StackPanel>

                                                                <Button Grid.Column="3"
                                                                        Content="â†"
                                                                        Command="{Binding DataContext.RemoveOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        Style="{StaticResource SecondaryButton}"
                                                                        Width="32"
                                                                        Height="32"
                                                                        Padding="0"
                                                                        FontSize="14"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        ToolTip="Send to pool"/>

                                                                <TextBlock Grid.Column="4"
                                                                           Text="{Binding Quantity}"
                                                                           VerticalAlignment="Center"
                                                                           HorizontalAlignment="Center"
                                                                           FontWeight="Bold"
                                                                           FontSize="16"
                                                                           Foreground="{DynamicResource PrimaryLightBrush}"/>

                                                                <Button Grid.Column="5"
                                                                        Content="â†’"
                                                                        Command="{Binding DataContext.AddOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        Style="{StaticResource SecondaryButton}"
                                                                        Width="32"
                                                                        Height="32"
                                                                        Padding="0"
                                                                        FontSize="14"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        ToolTip="Get from pool"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>

                <!-- Items Section - By Item (alternate view) -->
                <Grid Grid.Row="2" Visibility="{Binding IsItemView, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredItemAllocations}" Margin="16">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Vertical"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource SurfaceHoverBrush}"
                                            BorderThickness="1"
                                            CornerRadius="12"
                                            Padding="16"
                                            Margin="0,0,0,12">
                                        <StackPanel>
                                            <!-- Item Header -->
                                            <Grid Margin="0,0,0,12">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Orientation="Horizontal" Grid.Column="0">
                                                    <TextBlock Text="ðŸ“¦" FontSize="18" Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding DisplayItem}" FontWeight="Bold" FontSize="16"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <Border Background="{StaticResource AllocationAccentBrush}" CornerRadius="8" Padding="10,4" Margin="0,0,8,0">
                                                        <TextBlock Text="{Binding TotalQuantity, StringFormat='Total: {0}'}"
                                                                   Foreground="{DynamicResource TextOnPrimaryBrush}"
                                                                   FontWeight="Bold"
                                                                   FontSize="12"/>
                                                    </Border>
                                                    <TextBlock Text="{Binding StoreCount, StringFormat='{}{0} stores'}"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               FontSize="13"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Grid>

                                            <!-- Store Allocations List -->
                                            <ItemsControl ItemsSource="{Binding StoreAllocations}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{DynamicResource SurfaceHoverBrush}"
                                                                CornerRadius="8"
                                                                Padding="12,8"
                                                                Margin="0,0,0,6">
                                                            <Grid VerticalAlignment="Center">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="50"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <TextBlock Grid.Column="0" Text="ðŸª" FontSize="14" Margin="0,0,10,0" VerticalAlignment="Center"/>

                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding DisplayStore}"
                                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                                           FontWeight="Medium"
                                                                           VerticalAlignment="Center"
                                                                           TextTrimming="CharacterEllipsis"/>

                                                                <Button Grid.Column="2"
                                                                        Content="â†"
                                                                        Command="{Binding DataContext.RemoveOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding Item}"
                                                                        Style="{StaticResource SecondaryButton}"
                                                                        Width="28"
                                                                        Height="28"
                                                                        Padding="0"
                                                                        FontSize="12"
                                                                        Margin="8,0,0,0"
                                                                        VerticalAlignment="Center"
                                                                        ToolTip="Send to pool"/>

                                                                <TextBlock Grid.Column="3"
                                                                           Text="{Binding Quantity}"
                                                                           VerticalAlignment="Center"
                                                                           HorizontalAlignment="Center"
                                                                           FontWeight="Bold"
                                                                           FontSize="14"
                                                                           Foreground="{DynamicResource PrimaryLightBrush}"/>

                                                                <Button Grid.Column="4"
                                                                        Content="â†’"
                                                                        Command="{Binding DataContext.AddOneCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding Item}"
                                                                        Style="{StaticResource SecondaryButton}"
                                                                        Width="28"
                                                                        Height="28"
                                                                        Padding="0"
                                                                        FontSize="12"
                                                                        VerticalAlignment="Center"
                                                                        ToolTip="Get from pool"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>

                <!-- Status Bar -->
                <Border Grid.Row="4" Background="{DynamicResource SurfaceBrush}" BorderBrush="{DynamicResource SurfaceHoverBrush}" BorderThickness="0,1,0,0" Padding="16,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" 
                                   Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" FontSize="12"/>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <TextBlock Text="ðŸ’¾" FontSize="14" Margin="0,0,8,0"/>
                            <TextBlock Text="Ready" Foreground="{DynamicResource SuccessLightBrush}" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>





