<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Allocation Viewer</title>
  <!-- Unified Theme Styles -->
  <link rel="stylesheet" href="../../css/unified-theme.css">
  <!-- Allocation Buddy Specific Styles -->
  <link rel="stylesheet" href="src/styles/styles.css">
  
  <!-- Theme Management - Must run before body renders -->
  <script>
    // Apply theme from parent immediately
    (function() {
      try {
        // Check if we're in an iframe and get theme from parent
        if (window.parent && window.parent !== window) {
          const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
          if (parentTheme) {
            document.documentElement.setAttribute('data-theme', parentTheme);
          }
        } else {
          // Standalone mode - check localStorage
          const savedTheme = localStorage.getItem('app-theme') || 'dark';
          document.documentElement.setAttribute('data-theme', savedTheme);
        }
      } catch (e) {
        console.log('Theme init:', e);
        // Fallback to dark theme
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
</head>
<body>
  <script>
    // Mute console in production for module frames
    (async () => {
      try {
        const isDev = await window.electronAPI?.isDev?.();
        window.DEBUG = !!isDev;
        if (!window.DEBUG) {
          console.log = () => {};
          console.debug = () => {};
          console.info = () => {};
        }
      } catch (err) {
        window.DEBUG = false;
      }
    })();
  </script>
  <div class="module-container">
      <!-- Welcome Screen - Shown when no data is loaded -->
      <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
          <div class="welcome-icon">üìä</div>
          <h1 class="welcome-title">Allocation Buddy</h1>
          <p class="welcome-subtitle">Visualize and manage your store allocations</p>
          <div class="welcome-divider"></div>
          <button id="selectFileBtn" class="btn-welcome">
            <span class="btn-welcome-icon">üìÅ</span>
            <span class="btn-welcome-text">Select Excel or CSV File</span>
          </button>
          <p class="welcome-hint">Supports .xlsx, .xls, and .csv formats</p>
        </div>
      </div>

      <!-- Data View - Shown when data is loaded -->
      <div id="dataView" style="display: none;">
        <!-- File Controls -->
        <div class="control-bar">
          <input type="text" id="filePathDisplay" class="file-path-display input-modern" readonly placeholder="No file selected">
          <button id="clearBtn" class="btn-modern btn-outline-modern">
            <span class="icon">üóëÔ∏è</span>
            Clear & Start Over
          </button>
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info-banner" style="display: none;"></div>

      <!-- Stats Cards -->
      <div class="stats-grid grid-modern grid-3 animate-slide-up" id="statsContainer" style="display: none;">
        <div class="stat-card-modern">
          <div class="stat-card-icon">üè™</div>
          <div class="stat-card-content">
            <div class="stat-card-label">Total Stores</div>
            <div class="stat-card-value" id="totalStores">0</div>
          </div>
        </div>
        <div class="stat-card-modern">
          <div class="stat-card-icon">üëï</div>
          <div class="stat-card-content">
            <div class="stat-card-label">Total Styles</div>
            <div class="stat-card-value" id="totalItems">0</div>
          </div>
        </div>
        <div class="stat-card-modern">
          <div class="stat-card-icon">üì¶</div>
          <div class="stat-card-content">
            <div class="stat-card-label">Total Quantity</div>
            <div class="stat-card-value" id="totalQuantity">0</div>
          </div>
        </div>
      </div>

      <!-- Store Selection Section -->
      <div class="content-section" id="storeSelectionSection" style="display: none;">
        <div class="section-header-modern">
          <h2 class="section-title-modern">Store Selection</h2>
          <p class="section-subtitle-modern">Check/uncheck stores to include or exclude them</p>
        </div>
        <div class="selection-controls">
          <button id="selectAllStores" class="btn-modern btn-outline-modern">Select All</button>
          <button id="deselectAllStores" class="btn-modern btn-outline-modern">Deselect All</button>
          <span class="live-indicator">
            <span class="pulse-dot"></span>
            Live Updates
          </span>
        </div>
        <div id="storeCheckboxList" class="store-checkbox-grid"></div>
      </div>

      <!-- Excluded/Redistribution Section -->
      <div class="content-section" id="excludedSection" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">Excluded Stores - Redistribution</h2>
          <p class="section-description">Allocations from excluded stores ready for redistribution</p>
        </div>
        <div class="action-bar">
          <button id="exportExcluded" class="btn btn-secondary">
            <span class="icon">üì§</span>
            Export Excluded
          </button>
          <button id="redistributeEqually" class="btn btn-primary">
            <span class="icon">‚öñÔ∏è</span>
            Redistribute Equally
          </button>
          <button id="redistributeByRank" class="btn btn-primary">
            <span class="icon">‚≠ê</span>
            Redistribute by Rank
          </button>
        </div>
        <div id="excludedDataDisplay" class="data-container"></div>
      </div>

      <!-- View Toggle & Controls -->
      <div class="toolbar" id="viewToolbar" style="display: none;">
        <div class="btn-group">
          <button id="viewByStore" class="btn-toggle active">View by Store</button>
          <button id="viewByItem" class="btn-toggle">View by Item</button>
        </div>
        <div class="toolbar-actions">
          <button id="collapseAllBtn" class="btn btn-secondary btn-small" onclick="collapseAllStores()">
            <span class="icon">‚ñ≤</span>
            Collapse All
          </button>
          <button id="expandAllBtn" class="btn btn-secondary btn-small" onclick="expandAllStores()">
            <span class="icon">‚ñº</span>
            Expand All
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="modern-card" id="filterBar" style="display: none;">
        <div class="filter-bar-modern">
          <div class="filter-group-modern">
            <label for="storeFilter" class="filter-label-modern">Store:</label>
            <select id="storeFilter" class="input-modern select-modern">
              <option value="">All Stores</option>
            </select>
          </div>
          <div class="filter-group-modern">
            <label for="searchBox" class="filter-label-modern">Search:</label>
            <input type="text" id="searchBox" class="input-modern" placeholder="Search items...">
          </div>
          <button id="clearFilters" class="btn-modern btn-outline-modern">Clear Filters</button>
        </div>
      </div>

      <!-- Main Data Display -->
      <div id="dataDisplay" class="data-display">
        <div id="allocationsContent" class="allocations-content">
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <h3>No Data Loaded</h3>
            <p>Select an Excel or CSV file to get started</p>
            <p class="empty-hint">or drag and drop a file anywhere</p>
          </div>
        </div>
      </div>

      </div><!-- End dataView -->
  </div><!-- End module-container -->

  <!-- Drag & Drop Overlay -->
  <div id="dropZone" class="drop-zone-overlay" style="display: none;">
    <div class="drop-zone-content">
      <div class="drop-zone-icon">üìÅ</div>
      <h2>Drop your file here</h2>
      <p>Excel (.xlsx, .xls) or CSV files</p>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="loadingTitle">
    <div class="loading-modal">
      <div class="loading-spinner" role="status" aria-label="Loading">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <h2 id="loadingTitle" class="loading-title">Processing File</h2>
      <p class="loading-message">Please wait while we parse your data<span class="loading-dots"></span></p>
      <div class="loading-progress" id="loadingProgress" role="progressbar" aria-valuemin="0" aria-valuemax="4" aria-valuenow="0">
        <div class="progress-item" id="progress-reading">
          <div class="progress-icon" aria-hidden="true">üìñ</div>
          <div class="progress-text">Reading file</div>
        </div>
        <div class="progress-item" id="progress-parsing">
          <div class="progress-icon" aria-hidden="true">üîç</div>
          <div class="progress-text">Parsing data</div>
        </div>
        <div class="progress-item" id="progress-matching">
          <div class="progress-icon" aria-hidden="true">üîó</div>
          <div class="progress-text">Matching dictionary entries</div>
        </div>
        <div class="progress-item" id="progress-organizing">
          <div class="progress-icon" aria-hidden="true">üìä</div>
          <div class="progress-text">Organizing results</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticky Undo/Redo Buttons -->
  <div id="stickyActions" class="sticky-actions" role="group" aria-label="Undo and redo actions">
    <button id="undoBtn" class="btn btn-secondary" disabled title="Nothing to undo" aria-label="Undo last action">
      <span class="icon" aria-hidden="true">‚Ü∂</span>
    </button>
    <button id="redoBtn" class="btn btn-secondary" disabled title="Nothing to redo" aria-label="Redo last undone action">
      <span class="icon" aria-hidden="true">‚Ü∑</span>
    </button>
  </div>

  <!-- Store Details Modal -->
  <div id="storeModal" class="store-modal-overlay" style="display: none;">
    <div class="store-modal">
      <div class="store-modal-header">
        <div class="store-modal-title">
          <h2 id="storeModalName">Store Details</h2>
          <div id="storeModalBadge" class="store-modal-badge"></div>
        </div>
        <button class="store-modal-close" onclick="closeStoreModal()">‚úï</button>
      </div>
      <div class="store-modal-stats">
        <div class="modal-stat">
          <span class="modal-stat-label">Total Styles:</span>
          <span class="modal-stat-value" id="modalTotalItems">0</span>
        </div>
        <div class="modal-stat">
          <span class="modal-stat-label">Total Quantity:</span>
          <span class="modal-stat-value" id="modalTotalQty">0</span>
        </div>
      </div>
      <div class="store-modal-actions">
        <input type="text" id="modalSearchBox" class="modal-search" placeholder="Search items in this store...">
        <button class="btn btn-primary btn-small" onclick="copyStoreDataFromModal()">
          <span class="icon">üìã</span>
          Copy for Business Central
        </button>
      </div>
      <div class="store-modal-content" id="storeModalContent">
        <!-- Items will be populated here -->
      </div>
    </div>
  </div>

  <!-- Archive Viewer Modal -->
  <div id="archiveModal" class="archive-modal-overlay" style="display: none;">
    <div class="archive-modal">
      <div class="archive-modal-header">
        <h2>üì¶ Allocation Archives</h2>
        <button class="archive-modal-close" onclick="closeArchiveModal()">‚úï</button>
      </div>
      <div class="archive-modal-controls">
        <input type="text" id="archiveSearchBox" class="archive-search" placeholder="üîç Search archives...">
        <select id="archiveRetentionSelect" class="archive-retention-select">
          <option value="30">Keep 30 days</option>
          <option value="60">Keep 60 days</option>
          <option value="90" selected>Keep 90 days</option>
          <option value="180">Keep 180 days</option>
          <option value="365">Keep 1 year</option>
        </select>
        <button class="btn btn-secondary btn-small" onclick="manualCleanupArchives()">
          <span class="icon">üóëÔ∏è</span>
          Cleanup Old
        </button>
      </div>
      <div class="archive-modal-stats" id="archiveStats">
        <span class="archive-stat-item">Total: <strong>0</strong></span>
        <span class="archive-stat-item">Storage: <strong>0 KB</strong></span>
      </div>
      <div class="archive-modal-content" id="archiveModalContent">
        <!-- Archives will be populated here -->
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal-overlay" style="display: none;">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <h2>‚öôÔ∏è Dictionary Settings</h2>
        <button class="settings-modal-close" onclick="closeSettingsModal()">‚úï</button>
      </div>
      
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="items">Items (0)</button>
        <button class="settings-tab" data-tab="stores">Stores (0)</button>
        <button class="settings-tab" data-tab="export">Export/Import</button>
      </div>

      <div class="settings-content">
        <!-- Items Tab -->
        <div id="settingsTabItems" class="settings-tab-content active">
          <div class="settings-actions">
            <input type="text" id="settingsItemSearch" class="settings-search" placeholder="üîç Search items by number, description, or SKU...">
            <button class="btn btn-primary btn-small" onclick="showAddItemDialog()">
              <span class="icon">‚ûï</span>
              Add New Item
            </button>
          </div>
          <div class="settings-list" id="settingsItemsList">
            <!-- Items will be populated here -->
          </div>
        </div>

        <!-- Stores Tab -->
        <div id="settingsTabStores" class="settings-tab-content">
          <div class="settings-actions">
            <input type="text" id="settingsStoreSearch" class="settings-search" placeholder="üîç Search stores by ID or name...">
            <button class="btn btn-primary btn-small" onclick="showAddStoreDialog()">
              <span class="icon">‚ûï</span>
              Add New Store
            </button>
          </div>
          <div class="settings-list" id="settingsStoresList">
            <!-- Stores will be populated here -->
          </div>
        </div>

        <!-- Export/Import Tab -->
        <div id="settingsTabExport" class="settings-tab-content">
          <div class="export-section">
            <h3>üíæ Save Dictionary Permanently</h3>
            <p>Save all changes to the dictionary file (creates backup automatically)</p>
            <button class="btn btn-primary" onclick="saveDictionaryToFile()">
              <span class="icon">üíæ</span>
              Save to File
            </button>
          </div>
          <div class="export-section">
            <h3>Export Dictionary</h3>
            <p>Download the current dictionary as a JSON file to any location</p>
            <button class="btn btn-secondary" onclick="exportDictionary()">
              <span class="icon">üì•</span>
              Export Dictionary
            </button>
          </div>
          <div class="import-section">
            <h3>Import Dictionary</h3>
            <p>Import items and stores from a JSON file (merges with existing)</p>
            <button class="btn btn-secondary" onclick="importDictionary()">
              <span class="icon">üì§</span>
              Import Dictionary
            </button>
          </div>
          <div class="stats-section">
            <h3>Dictionary Statistics</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">Total Items:</span>
                <span class="stat-value" id="statTotalItems">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Total Stores:</span>
                <span class="stat-value" id="statTotalStores">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Items with SKUs:</span>
                <span class="stat-value" id="statItemsWithSkus">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Dictionary Size:</span>
                <span class="stat-value" id="statDictSize">0 KB</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Store Dialog -->
  <div id="addStoreDialog" class="add-item-dialog-overlay" style="display: none;">
    <div class="add-item-dialog">
      <div class="add-item-header">
        <h3>Add New Store</h3>
        <button class="add-item-close" onclick="closeAddStoreDialog()">‚úï</button>
      </div>
      <form id="addStoreForm" class="add-item-form">
        <div class="form-group">
          <label for="newStoreId">Store ID *</label>
          <input type="number" id="newStoreId" required placeholder="e.g., 101">
        </div>
        <div class="form-group">
          <label for="newStoreName">Store Name *</label>
          <input type="text" id="newStoreName" required placeholder="e.g., WATERLOO 1">
        </div>
        <div class="form-group">
          <label for="newStoreRank">Rank (Optional)</label>
          <input type="text" id="newStoreRank" placeholder="e.g., A, B, C">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddStoreDialog()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Store</button>
        </div>
      </form>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <!-- Theme Change Listener -->
  <script>
    // Listen for theme changes from parent window
    window.addEventListener('message', (event) => {
      if (event.data.type === 'themeChanged') {
        document.documentElement.setAttribute('data-theme', event.data.theme);
      }
    });
  </script>
  
  <!-- Application Scripts -->
  <script src="src/js/constants.js"></script>
    <script>
    // Try to load a user-saved dictionary first, otherwise try a JSON asset, then fallback to bundled dictionaries.js
    (async () => {
      try {
        // 1) user-saved dictionary (userData)
        const res = await window.electronAPI?.loadUserDictionary?.();
        if (res?.success && res.data) {
          window.DICT = res.data;
          return;
        }

        // 2) try to fetch a local JSON copy (fast to parse)
        try {
          const r = await fetch('src/js/dictionaries.json');
          if (r.ok) {
            window.DICT = await r.json();
            return;
          }
        } catch (e) {
          // ignore fetch errors and fall through to bundled script
        }

        // 3) fallback to bundled script
        const s = document.createElement('script');
        s.src = 'src/js/dictionaries.js';
        document.head.appendChild(s);
      } catch (err) {
        const s = document.createElement('script');
        s.src = 'src/js/dictionaries.js';
        document.head.appendChild(s);
      }
    })();
  </script>
  <script src="src/js/init-shared.js"></script>
  <script src="src/js/archiveManager.js"></script>
  <script src="src/js/renderer.js"></script>
</body>
</html>
