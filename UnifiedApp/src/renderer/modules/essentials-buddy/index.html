<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essentials Buddy</title>
    <link rel="stylesheet" href="../../css/unified-theme.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Module Container -->
    <div class="module-container">
        <!-- Welcome Screen - Shown when no data is loaded -->
        <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-card">
                    <div class="welcome-icon">ğŸ“‹</div>
                    <h1 class="welcome-title">Essentials Buddy</h1>
                    <p class="welcome-subtitle">Business Central Bin Contents Reporter</p>
                    <div class="welcome-divider"></div>
                    <button id="selectFileWelcomeBtn" class="btn-welcome">
                        <span class="btn-welcome-icon">ğŸ“</span>
                        <span class="btn-welcome-text">Select Bin Contents File</span>
                    </button>
                    <p class="welcome-hint">Supports .xlsx and .xls formats</p>
                </div>
        </div>

        <!-- Data View - Shown when data is loaded -->
        <div id="dataView" style="display: none;">
            <!-- File Controls -->
            <div class="control-bar">
                    <input type="text" id="filePathDisplay" class="file-path-display input-modern" readonly placeholder="No file selected">
                    <button id="clearBtn" class="btn-modern btn-outline-modern">
                        <span class="icon">ğŸ—‘ï¸</span>
                        Clear & Start Over
                    </button>
                </div>

            <!-- Status Message -->
            <div id="status" class="status-message"></div>

            <!-- Statistics -->
            <div id="statsSection" class="stats-section">
                <div class="stats-grid grid-modern grid-4 animate-slide-up">
                    <div class="stat-card-modern">
                        <div class="stat-card-icon">ğŸ“Š</div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Total Items</div>
                            <div class="stat-card-value" id="totalItems">0</div>
                        </div>
                    </div>
                    <div class="stat-card-modern">
                        <div class="stat-card-icon">ğŸ”´</div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">No Inventory</div>
                            <div class="stat-card-value" id="noInventory">0</div>
                        </div>
                    </div>
                    <div class="stat-card-modern">
                        <div class="stat-card-icon">ğŸŸ¡</div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Low Inventory</div>
                            <div class="stat-card-value" id="lowInventory">0</div>
                        </div>
                    </div>
                    <div class="stat-card-modern">
                        <div class="stat-card-icon">ğŸŸ¢</div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Sufficient Stock</div>
                            <div class="stat-card-value" id="sufficient">0</div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Report Section -->
        <div id="reportSection" class="report-section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="section-title-modern">Inventory Status Report</h3>
                        <div class="header-actions">
                            <button class="btn-modern btn-gradient" id="exportExcelBtn">ğŸ“Š Export Excel</button>
                            <button class="btn-modern btn-outline-modern" id="exportCsvBtn">ğŸ“„ Export CSV</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Advanced Filters -->
                        <details class="filter-section">
                            <summary class="filter-header">ğŸ” Advanced Filters</summary>
                            <div class="filter-content">
                                <div class="filter-group">
                                    <label>Quantity Range:</label>
                                    <div class="range-inputs">
                                        <input type="number" id="qtyMin" placeholder="Min" class="range-input">
                                        <span>to</span>
                                        <input type="number" id="qtyMax" placeholder="Max" class="range-input">
                                        <button onclick="applyFilters()" class="btn-mini">Apply</button>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label>Threshold Range:</label>
                                    <div class="range-inputs">
                                        <input type="number" id="thresholdMin" placeholder="Min" class="range-input">
                                        <span>to</span>
                                        <input type="number" id="thresholdMax" placeholder="Max" class="range-input">
                                        <button onclick="applyFilters()" class="btn-mini">Apply</button>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label>Quick Presets:</label>
                                    <div class="preset-buttons">
                                        <button onclick="applyPreset('critical')" class="preset-btn">Critical (Qty = 0)</button>
                                        <button onclick="applyPreset('urgent')" class="preset-btn">Urgent (Qty < 5)</button>
                                        <button onclick="applyPreset('reorder')" class="preset-btn">Below Threshold</button>
                                        <button onclick="applyPreset('reset')" class="preset-btn reset">Reset All</button>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Table Filters -->
                        <div class="filters-row">
                            <input type="text" id="searchInput" class="input" placeholder="ğŸ” Search by item number or description...">
                            <select id="statusFilter" class="input">
                                <option value="all">All Items</option>
                                <option value="No Inventory">No Inventory</option>
                                <option value="Low Inventory">Low Inventory</option>
                                <option value="Sufficient">Sufficient</option>
                            </select>
                        </div>

                        <!-- Report Table -->
                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('itemNo')">Item No</th>
                                        <th class="sortable" onclick="sortTable('description')">Description</th>
                                        <th class="sortable" onclick="sortTable('quantity')">Quantity</th>
                                        <th class="sortable" onclick="sortTable('threshold')">Threshold</th>
                                        <th class="sortable" onclick="sortTable('status')">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reportBody">
                                    <!-- Report rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">âš™ï¸ Application Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body" style="display: flex;">
                <!-- Settings Tabs -->
                <div class="tabs vertical-tabs">
                    <button class="tab active" onclick="switchTab(event, 'masterListTab')">
                        ğŸ“‹ Master List
                    </button>
                    <button class="tab" onclick="switchTab(event, 'thresholdsTab')">
                        ğŸ¯ Thresholds
                    </button>
                    <button class="tab" onclick="switchTab(event, 'preferencesTab')">
                        âš™ï¸ Preferences
                    </button>
                    <button class="tab" onclick="switchTab(event, 'dataTab')">
                        ğŸ’¾ Data Management
                    </button>
                    <button class="tab" onclick="switchTab(event, 'aboutTab')">
                        â„¹ï¸ About
                    </button>
                </div>

                <!-- Settings Content -->
                <div class="settings-content-area">
                    <!-- Master List Tab -->
                    <div id="masterListTab" class="tab-panel active">
                        <h3>ğŸ“‹ Master List Management</h3>
                        <p>Manage your item database with imports from Business Central.</p>

                        <div class="card status-card">
                            <div class="card-body">
                                <div class="badge badge-success">âœ… Status</div>
                                <div id="masterListCount" class="status-count">Loading...</div>
                                <p class="status-label">Items currently loaded</p>
                            </div>
                        </div>

                        <div class="card import-card">
                            <div class="card-header">
                                <h4 class="card-title">ğŸ“¤ Import Item List</h4>
                            </div>
                            <div class="card-body">
                                <p class="card-description">Upload an Excel export from Business Central containing Item No. and Description columns.</p>

                                <div class="drag-drop-area">
                                    <input type="file" id="retailListFile" class="file-input" accept=".xlsx,.xls">
                                    <div class="drag-drop-icon">ğŸ“</div>
                                    <div class="drag-drop-text">Choose Item List Export</div>
                                    <div class="drag-drop-hint" id="retailListFileName">No file selected</div>
                                </div>

                                <button id="updateRetailListBtn" class="btn btn-primary import-btn" disabled>
                                    ğŸ’¾ Import & Update
                                </button>
                            </div>
                        </div>

                        <div class="card export-card">
                            <div class="card-header">
                                <h4 class="card-title">ğŸ“¥ Export & Backup</h4>
                            </div>
                            <div class="card-body">
                                <button id="exportDictionaryBtn" class="btn btn-primary">
                                    ğŸ“¥ Export Dictionary (JSON)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Thresholds Tab -->
                    <div id="thresholdsTab" class="tab-panel">
                        <h3>ğŸ¯ Threshold Management</h3>
                        <p>Configure inventory thresholds to determine low stock levels.</p>

                        <div class="card status-card">
                            <div class="card-body">
                                <div class="badge badge-success">âœ… Status</div>
                                <div id="thresholdsCount" class="status-count">Loading...</div>
                                <p class="status-label">Custom thresholds configured</p>
                            </div>
                        </div>

                        <div class="card threshold-edit-card">
                            <div class="card-header">
                                <h4 class="card-title">âœï¸ Edit Thresholds</h4>
                            </div>
                            <div class="card-body">
                                <div class="threshold-search-row">
                                    <input type="text" id="thresholdSearchInput" placeholder="Search items..." class="input threshold-search-input">
                                    <button onclick="showAllThresholds()" class="btn btn-secondary">ğŸ“‹ View All</button>
                                </div>

                                <div id="thresholdEditContainer" class="threshold-edit-container">
                                    <div class="threshold-empty-state">
                                        <div class="empty-icon">ğŸ”</div>
                                        <div>Start typing to search for items...</div>
                                        <div class="empty-hint">Minimum 2 characters required</div>
                                    </div>
                                </div>

                                <div id="bulkSaveContainer" class="bulk-save-container">
                                    <button id="bulkSaveBtn" class="btn btn-primary">ğŸ’¾ Save All Changes</button>
                                    <span id="changedCount" class="changed-count"></span>
                                </div>
                            </div>
                        </div>

                        <div class="card export-card">
                            <div class="card-header">
                                <h4 class="card-title">ğŸ“¥ Export Thresholds</h4>
                            </div>
                            <div class="card-body">
                                <button id="exportThresholdsBtn" class="btn btn-primary">
                                    ğŸ“¥ Export Thresholds (JSON)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preferences Tab -->
                    <div id="preferencesTab" class="tab-panel">
                        <h3>âš™ï¸ User Preferences</h3>
                        <p>Customize the application to suit your workflow.</p>

                        <div class="card preferences-card">
                            <div class="card-header">
                                <h4 class="card-title">Display Settings</h4>
                            </div>
                            <div class="card-body">
                                <div class="preference-group">
                                    <label for="itemsPerPagePref">Items Per Page:</label>
                                    <select id="itemsPerPagePref" class="input" onchange="savePreference('itemsPerPage', this.value)">
                                        <option value="50">50 items</option>
                                        <option value="100" selected>100 items</option>
                                        <option value="200">200 items</option>
                                    </select>
                                </div>

                                <div class="preference-group">
                                    <label for="defaultSortPref">Default Sort Column:</label>
                                    <select id="defaultSortPref" class="input" onchange="savePreference('defaultSort', this.value)">
                                        <option value="itemNo">Item Number</option>
                                        <option value="description">Description</option>
                                        <option value="quantity">Quantity</option>
                                        <option value="threshold">Threshold</option>
                                        <option value="status" selected>Status</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="card reset-card">
                            <div class="card-body">
                                <button onclick="resetPreferences()" class="btn btn-danger btn-full-width">
                                    Reset All Preferences
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management Tab -->
                    <div id="dataTab" class="tab-panel">
                        <h3>ğŸ’¾ Data Storage & Management</h3>
                        <p>Manage your application data and storage.</p>

                        <div class="card data-management-card">
                            <div class="card-body">
                                <button id="reloadDataBtn" class="btn btn-secondary btn-full-width btn-with-margin">
                                    ğŸ”„ Reload from Files
                                </button>
                                <button id="clearAllDataBtn" class="btn btn-danger btn-full-width">
                                    ğŸ—‘ï¸ Clear All Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- About Tab -->
                    <div id="aboutTab" class="tab-panel">
                        <h3>â„¹ï¸ About Essentials Buddy</h3>
                        <p>Business Central Bin Contents Report Generator</p>

                        <div class="card features-card">
                            <div class="card-header">
                                <h4 class="card-title">ğŸš€ Features</h4>
                            </div>
                            <div class="card-body">
                                <ul class="features-list">
                                    <li>ğŸ“Š Smart filtering (9-90* bins)</li>
                                    <li>ğŸ¯ Threshold management</li>
                                    <li>ğŸ“¤ Excel and CSV export</li>
                                    <li>ğŸ’¾ Data persistence</li>
                                    <li>ğŸ” Advanced search and filters</li>
                                    <li>ğŸ“‹ Pagination support</li>
                                    <li>âŒ¨ï¸ Keyboard shortcuts</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card version-card">
                            <div class="card-body">
                                <strong>Version:</strong> 3.0 (Unified)<br>
                                <strong>Last Updated:</strong> October 2025
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loadingText" class="loading-text">Processing...</div>
        <div id="loadingSubtext" class="loading-subtext">Please wait</div>
    </div>

    <!-- Theme Change Listener -->
    <script>
      // Apply theme from parent immediately if in iframe
      (function() {
        try {
          if (window.parent && window.parent !== window) {
            const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
            if (parentTheme) {
              document.documentElement.setAttribute('data-theme', parentTheme);
            }
          }
        } catch (e) {
          console.log('Theme init:', e);
        }
      })();

      // Listen for theme changes from parent window
      window.addEventListener('message', (event) => {
        if (event.data.type === 'themeChanged') {
          document.documentElement.setAttribute('data-theme', event.data.theme);
        }
      });
    </script>

    <script src="../../js/shared-utils.js"></script>
    <script src="js/essentials-buddy.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
